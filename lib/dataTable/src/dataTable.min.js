"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.search"),require("core-js/modules/web.dom-collections.for-each"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue"));require("vxe-table/lib/index.css");var _utils=_interopRequireDefault(require("../../utils")),_vxeTable=require("vxe-table"),_dataForm=require("../../dataForm"),_conf=_interopRequireDefault(require("../conf")),_setColums=_interopRequireDefault(require("./setColums")),tablePropKeys=Object.keys(_vxeTable.Table.props),methods={};function renderHeadSearch(e,o,t){var r=t.onSearchSubmit,a=t.onButtonActionClick,n=t.$scopedSlots,s=e.items.filter(function(e){return!e.folding});return o("data-form",{ref:"headSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),{},{items:s}),class:"head-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.on),{},{buttonActionClick:a,submit:r}),scopedSlots:n})}function renderAdvancedSearch(e,o,t){var r=t.onSearchSubmit,a=t.advancedVisible,n=t.onAdvancedcancel,s=t.onAdvancedSubmit,u=t.$scopedSlots,i=e.items.filter(function(e){return!1!==e.folding}),c=e.advancedSearchForm&&e.advancedSearchForm.props?e.advancedSearchForm.props:{},l=o("data-form",{ref:"advancedSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},c),{},{items:i,layout:e.foldingLayout?e.foldingLayout:"flex"}),class:"advanced-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.on),{},{submit:r}),scopedSlots:u}),d=e.advancedSearchModal&&e.advancedSearchModal.props?e.advancedSearchModal.props:{};return o("a-modal",(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.advancedSearchModal),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},d),{},{title:d.title?d.title:"高级搜索",visible:a}),on:{cancel:n,ok:s},class:"advanced-search-modal"}),[l])}function renderColumnsModal(e,o){var t=o.backupColumns,r=o.setTableColumns;return e("SetColums",{ref:"setColumsModal",props:{option:o.setColumnsOpt,columns:t},on:{submit:r}})}function renderButton(e,o,t,r){var a=e.name,n=e.icon,s=e.disabled,u=e.code,i=e.on,c=r.onToobarButtonClick,l="";n&&(l=o("a-icon",{props:{type:n}}));var d=function(e){c(u),i&&i.click&&i.click(e)};return t?o("a-menu-item",{key:u,props:{disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},i),{},{click:d})},[l,a]):o("a-button",{key:u,props:{type:e.type,disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},i),{},{click:d})},[l,a])}function renderButtons(e,a,n){return e?e.map(function(e){if("[object Array]"===Object.prototype.toString.call(e)){var o=e.map(function(e){return renderButton(e,a,!1,n)});return a("a-button-group",{},[o])}if(e.dropdowns&&e.dropdowns.length){var t=e.dropdowns.map(function(e){return renderButton(e,a,!0,n)}),r=a("a-menu",{slot:"overlay"},[t]);return a("a-dropdown",{props:{disabled:e.disabled},scopedSlots:{overlay:function(){return r}}},[a("a-button",{},[e.name,a("a-icon",{props:{type:"down"}})])])}if("[object Object]"===Object.prototype.toString.call(e))return renderButton(e,a,!1,n)}):[]}function renderHeadToolbar(e,o){var t=o.headToolbar,r=o.$nextTick,a=o.$refs,n=o.showSetColumns,s=o.setcolumnsConfig;if(!t)return!1;var u={ref:"headToolbar",props:{},class:"head-toolbar",scopedSlots:{}};if(t.buttons){var i=renderButtons(t.buttons,e,o);u.scopedSlots.buttons=function(){return i}}var c="",l="";t.search&&(l=renderHeadSearch(t.search,e,o),c=renderAdvancedSearch(t.search,e,o));var d="";if(t.tools){if(u.props=(0,_objectSpread2.default)({},t.tools),t.tools.setColumns){var p=_utils.default.isObject(t.tools.setColumns)?t.tools.setColumns:{},f=e("a-button",{props:(0,_objectSpread2.default)({circle:!0,icon:"setting",shape:"circle"},p),class:"tool-btn-setcolumns",style:{marginRight:"10px"},on:{click:n}});u.scopedSlots.tools=l?function(){return e("div",{style:{display:"flex"}},[l,f])}:function(){return f},s||(d=renderColumnsModal(e,o))}r(function(){a.dataGrid.connect(a.headToolbar)})}return!u.scopedSlots.tools&&l&&(u.scopedSlots.tools=function(){return l}),e("div",{class:"head-toolbar-box"},[e("vxe-toolbar",u,[]),c,d])}function handleColumnsData(e,o,n){var s=_utils.default.clone(o),t=e.map(function(e){var o=(0,_objectSpread2.default)({},e);for(var t in n)"list"!==t&&(o[t]=e[n[t]]);if(s&&s.length){var r=s.findIndex(function(e){return e.field===o.field});if(-1<r){var a=s[r];o=(0,_objectSpread2.default)((0,_objectSpread2.default)({},o),a),s.splice(r,1)}}return o.children&&o.children.length&&(o.children=handleColumnsData(o.children,o.children,n)),o});s&&s.length&&(s=s.map(function(e){return e.colIndex||0===e.colIndex?(t.splice(e.colIndex,0,e),""):e}).filter(function(e){return""!=e}));return s&&s.length?t.concat(s):t}Object.keys(_vxeTable.Table.methods).forEach(function(o){methods[o]=function(){var e;return this.$refs.dataGrid&&(e=this.$refs.dataGrid)[o].apply(e,arguments)}});var _default2={name:"DataTable",components:{DataForm:_dataForm.DataForm,SetColums:_setColums.default},props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_vxeTable.Table.props),{},{columns:Array,pagerConfig:{type:[Boolean,Object],default:function(){}},proxyConfig:Object,toolbar:[Boolean,Object],formConfig:[Boolean,Object],zoomConfig:Object,searchConfig:Object,headToolbar:Object,setcolumnsConfig:Object,proxyColumns:Object}),watch:{columns:function(e){this.setTableColumns(e)}},data:function(){return{backupColumns:[],tableColumns:[],advancedVisible:!1,searchData:{}}},computed:{tableExtendProps:function(){var o=this,t={};return tablePropKeys.forEach(function(e){t[e]=o[e]}),t},pagerConfigOpt:function(){return this.pagerConfig?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.pagerConfig),this.pagerConfig):!this.pagerConfig&&!1!==this.pagerConfig&&_conf.default.pagerConfig},setColumnsOpt:function(){if(this.setcolumnsConfig){var e=this.setcolumnsConfig&&this.setcolumnsConfig.modal&&this.setcolumnsConfig.modal.props?this.setcolumnsConfig.modal.props:{},o=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.props?this.setcolumnsConfig.proxyConfig.props:{},t=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.ajax?this.setcolumnsConfig.proxyConfig.ajax:{};return{modal:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.modal.props),e)},proxyConfig:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.props),o),ajax:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.ajax),t)}}}return _conf.default.setColumns},proxyConfigOpt:function(){if(this.proxyConfig){var e=this.proxyConfig&&this.proxyConfig.props?this.proxyConfig.props:{};return(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig),this.proxyConfig),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.props),e)})}},tableProps:function(){var a=this,e=this.$listeners,o=this.$scopedSlots,t=this.tableExtendProps,r=this.handleTableQuery,n=this.tableColumns,s=this.renderCheckbox,u=this.pagerConfigOpt,i=this.proxyConfigOpt,c=this.$options.propsData,l=Object.assign({},t),d=n.map(function(e){return e.editRender&&e.editRender.name&&"ACheckbox"===e.editRender.name&&(e.slots={default:"a_checkbox",edit:"a_checkbox"},a.$scopedSlots.a_checkbox=s),e});Object.assign(l,{props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.props),c),{},{proxyConfig:i,columns:d})});var p={};_utils.default.each(e,function(e,r){p[r]=function(){for(var e=arguments.length,o=new Array(e),t=0;t<e;t++)o[t]=arguments[t];a.$emit.apply(a,[r].concat(o))}});var f=!1;if(l.props.proxyConfig&&l.props.proxyConfig.ajax&&l.props.proxyConfig.ajax.query){f=!0;var b=l.props.proxyConfig.ajax.query;l.props.proxyConfig.ajax.query=function(e){var o=r(e);return!1!==o&&(o&&(e=o),b(e))}}return!l.props.pagerConfig&&!1!==l.props.pagerConfig&&f&&(l.props.pagerConfig=u),l.on=p,l.ref="dataGrid",l.scopedSlots=o,l}},created:function(){var e=this.columns,o=this.proxyColumns,t=this.fetchColumns;o&&t(o),this.tableColumns=e||[]},mounted:function(){},beforeDestroy:function(){},destroyed:function(){},methods:(0,_objectSpread2.default)((0,_objectSpread2.default)({},methods),{},{reload:function(){var e=this.proxyConfig;e&&e.ajax&&e.ajax.query&&this.$refs.dataGrid.commitProxy("reload")},onSearchSubmit:function(e){this.searchData=e,this.$refs.dataGrid.commitProxy("reload")},handleTableQuery:function(e){var o=this.searchData,t=this.pagerConfigOpt,r={};t&&e.page&&(r[t.props.currentPage]=e.page.currentPage,r[t.props.pageSize]=e.page.pageSize);return(0,_objectSpread2.default)((0,_objectSpread2.default)({},o),r)},onButtonActionClick:function(e){var o=this,t=this.searchData;"advancedQuery"===e&&(this.advancedVisible=!0,this.$nextTick(function(){o.$refs.advancedSearch.setData(t)}))},onAdvancedSubmit:function(){var o=this,t=this.$refs,r=this.onAdvancedcancel;t.advancedSearch.validateFields().then(function(e){o.$refs.headSearch.setData(e),o.searchData=e,t.dataGrid.commitProxy("reload"),r()})},onAdvancedcancel:function(){this.advancedVisible=!1},showSetColumns:function(){this.$refs.setColumsModal.show()},setTableColumns:function(e){var o=this.proxyColumns,t=this.fetchColumns;if(e){this.backupColumns=_utils.default.clone(e);var r=o.props&&_utils.default.isObject(o.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),o.props):_conf.default.proxyColumns.props;this.tableColumns=e.filter(function(e){return!1!==e[r.show]})}else o&&t(o)},renderCheckbox:function(o){return(0,(new _vue.default).$createElement)("a-checkbox",{props:{checked:o.row[o.column.property]},on:{input:function(e){o.row[o.column.property]=e}}})},fetchColumns:function(r){var a=this,n=this.columns;r.ajax&&r.ajax.query&&r.ajax.query().then(function(e){var o=r.props&&_utils.default.isObject(r.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),r.props):_conf.default.proxyColumns.props,t=handleColumnsData(_utils.default.getObjData(o.list,e),n,o);a.backupColumns=_utils.default.clone(t),a.tableColumns=t.filter(function(e){return!1!==e[o.show]})})},onToobarButtonClick:function(e){this.$emit("toobarButtonClick",e)}}),render:function(e){var o=this.tableProps,t=this.headToolbar,r=this.setcolumnsConfig,a=[];return(t&&t.tools&&t.tools.setColumns||r)&&a.push(renderColumnsModal(e,this)),e("div",{class:"data-table"},[renderHeadToolbar(e,this),e("vxe-grid",o)].concat(a))}};exports.default=_default2;