"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.join"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.search"),require("core-js/modules/web.dom-collections.for-each"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue"));require("vxe-table/lib/index.css");var _utils=_interopRequireDefault(require("../../utils")),_vxeTable=require("vxe-table"),_dataForm=require("../../dataForm"),_conf=_interopRequireDefault(require("../conf")),_setColums=_interopRequireDefault(require("./setColums")),tablePropKeys=Object.keys(_vxeTable.Table.props),methods={};function renderHeadSearch(e,o,t){var r=t.onSearchSubmit,n=t.onButtonActionClick,a=t.$scopedSlots,s=e.items.filter(function(e){return!e.folding});return o("data-form",{ref:"headSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),{},{submitButtonProps:!1,items:s}),class:"head-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.on),{},{buttonActionClick:n,submit:r}),scopedSlots:a})}function renderAdvancedSearch(e,o,t){var r=t.onSearchSubmit,n=t.advancedVisible,a=t.onAdvancedcancel,s=t.onAdvancedSubmit,l=t.$scopedSlots,d=e.items.filter(function(e){return!1!==e.folding}),i=e.advancedSearchForm&&e.advancedSearchForm.props?e.advancedSearchForm.props:{},u=o("data-form",{ref:"advancedSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},i),{},{items:d,layout:e.foldingLayout?e.foldingLayout:"flex"}),class:"advanced-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.on),{},{submit:r}),scopedSlots:l}),c=e.advancedSearchModal&&e.advancedSearchModal.props?e.advancedSearchModal.props:{};return o("a-modal",(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.advancedSearchModal),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},c),{},{title:c.title?c.title:"高级搜索",visible:n}),on:{cancel:a,ok:s},class:"advanced-search-modal"}),[u])}function renderColumnsModal(e,o){var t=o.backupColumns,r=o.setTableColumns;return e("SetColums",{ref:"setColumsModal",props:{option:o.setColumnsOpt,columns:t},on:{submit:r}})}function renderButton(e,o,t,r){var n=e.name,a=e.icon,s=e.disabled,l=e.code,d=e.on,i=r.onToobarButtonClick,u="";a&&(u=o("a-icon",{props:{type:a}}));var c=function(e){i(l),d&&d.click&&d.click(e)};return t?o("a-menu-item",{key:l,props:{disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},d),{},{click:c})},[u,n]):o("a-button",{key:l,props:{type:e.type,disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},d),{},{click:c})},[u,n])}function renderButtons(e,n,a){return e?e.map(function(e){if("[object Array]"===Object.prototype.toString.call(e)){var o=e.map(function(e){return renderButton(e,n,!1,a)});return n("a-button-group",{},[o])}if(e.dropdowns&&e.dropdowns.length){var t=e.dropdowns.map(function(e){return renderButton(e,n,!0,a)}),r=n("a-menu",{slot:"overlay"},[t]);return n("a-dropdown",{props:{disabled:e.disabled},scopedSlots:{overlay:function(){return r}}},[n("a-button",{},[e.name,n("a-icon",{props:{type:"down"}})])])}if("[object Object]"===Object.prototype.toString.call(e))return renderButton(e,n,!1,a)}):[]}function renderHeadToolbar(e,o){var t=o.headToolbar,r=o.$nextTick,n=o.$refs,a=o.showSetColumns,s=o.setcolumnsConfig;if(!t)return!1;var l={ref:"headToolbar",props:{},class:"head-toolbar",scopedSlots:{}};if(t.buttons){var d=renderButtons(t.buttons,e,o);l.scopedSlots.buttons=function(){return d}}var i="",u="";t.search&&(u=renderHeadSearch(t.search,e,o),i=renderAdvancedSearch(t.search,e,o));var c="";if(t.tools){if(l.props=(0,_objectSpread2.default)({},t.tools),t.tools.setColumns){var p=_utils.default.isObject(t.tools.setColumns)?t.tools.setColumns:{},f=e("a-button",{props:(0,_objectSpread2.default)({circle:!0,icon:"setting",shape:"circle"},p),class:"tool-btn-setcolumns",style:{marginRight:"10px"},on:{click:a}});l.scopedSlots.tools=u?function(){return e("div",{style:{display:"flex"}},[u,f])}:function(){return f},s||(c=renderColumnsModal(e,o))}r(function(){n.dataGrid.connect(n.headToolbar)})}return!l.scopedSlots.tools&&u&&(l.scopedSlots.tools=function(){return u}),e("div",{class:"head-toolbar-box"},[e("vxe-toolbar",l,[]),i,c])}function handleColumnsData(e,o,a){var s=_utils.default.clone(o),t=e.map(function(e){var o=(0,_objectSpread2.default)({},e);for(var t in a)"list"!==t&&(o[t]=e[a[t]]);if(s&&s.length){var r=s.findIndex(function(e){return e.field===o.field});if(-1<r){var n=s[r];o=(0,_objectSpread2.default)((0,_objectSpread2.default)({},o),n),s.splice(r,1)}}return o.children&&o.children.length&&(o.children=handleColumnsData(o.children,o.children,a)),o});s&&s.length&&(s=s.map(function(e){return e.colIndex||0===e.colIndex?(t.splice(e.colIndex,0,e),""):e}).filter(function(e){return""!=e}));return s&&s.length?t.concat(s):t}Object.keys(_vxeTable.Table.methods).forEach(function(o){methods[o]=function(){var e;return this.$refs.dataGrid&&(e=this.$refs.dataGrid)[o].apply(e,arguments)}});var _default2={name:"DataTable",components:{DataForm:_dataForm.DataForm,SetColums:_setColums.default},props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_vxeTable.Table.props),{},{columns:Array,pagerConfig:{type:[Boolean,Object],default:function(){}},proxyConfig:Object,toolbar:[Boolean,Object],formConfig:[Boolean,Object],zoomConfig:Object,searchConfig:Object,headToolbar:Object,setcolumnsConfig:Object,proxyColumns:Object}),watch:{columns:function(e){this.setTableColumns(e)}},data:function(){return{backupColumns:[],tableColumns:[],advancedVisible:!1,searchData:{},tableHeight:""}},computed:{tableExtendProps:function(){var o=this,t={};return tablePropKeys.forEach(function(e){t[e]=o[e]}),t},pagerConfigOpt:function(){return this.pagerConfig?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.pagerConfig),this.pagerConfig):!this.pagerConfig&&!1!==this.pagerConfig&&_conf.default.pagerConfig},setColumnsOpt:function(){if(this.setcolumnsConfig){var e=this.setcolumnsConfig&&this.setcolumnsConfig.modal&&this.setcolumnsConfig.modal.props?this.setcolumnsConfig.modal.props:{},o=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.props?this.setcolumnsConfig.proxyConfig.props:{},t=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.ajax?this.setcolumnsConfig.proxyConfig.ajax:{};return{modal:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.modal.props),e)},proxyConfig:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.props),o),ajax:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.ajax),t)}}}return _conf.default.setColumns},proxyConfigOpt:function(){if(this.proxyConfig){var e=this.proxyConfig&&this.proxyConfig.props?this.proxyConfig.props:{};return(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig),this.proxyConfig),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.props),e)})}},tableProps:function(){var n=this,e=this.$listeners,o=this.$scopedSlots,t=this.tableExtendProps,r=this.handleTableQuery,a=this.tableColumns,s=this.renderCheckbox,l=this.pagerConfigOpt,d=this.proxyConfigOpt,i=this.renderPulldownTable,u=this.renderPulldownTableView,c=this.renderSwitch,p=this.height,f=this.$options.propsData,h=Object.assign({},t),m=a.map(function(e){return e.editRender&&e.editRender.name&&"ACheckbox"===e.editRender.name?(e.slots={default:"a_checkbox",edit:"a_checkbox"},n.$scopedSlots.a_checkbox=s):e.editRender&&e.editRender.name&&"ASwitch"===e.editRender.name?(e.slots={default:"a_switch",edit:"a_switch"},n.$scopedSlots.a_switch=c):e.editRender&&e.editRender.name&&"pulldownTable"===e.editRender.name&&(e.slots={default:"pulldownTableView",edit:"pulldownTable"},n.$scopedSlots.pulldownTableView=u,n.$scopedSlots.pulldownTable=i),e});Object.assign(h,{props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.props),f),{},{proxyConfig:d,columns:m})}),p&&_utils.default.isString(p)&&-1<p.indexOf("calc")&&(h.props.height="auto");var b={};_utils.default.each(e,function(e,r){b[r]=function(){for(var e=arguments.length,o=new Array(e),t=0;t<e;t++)o[t]=arguments[t];n.$emit.apply(n,[r].concat(o))}});var g=!1;if(h.props.proxyConfig&&h.props.proxyConfig.ajax&&h.props.proxyConfig.ajax.query){g=!0;var C=h.props.proxyConfig.ajax.query;h.props.proxyConfig.ajax.query=function(e){var o=r(e);return!1!==o&&(o&&(e=o),C(e))}}return!1!==h.props.pagerConfig&&g&&(h.props.pagerConfig=l),h.on=b,h.ref="dataGrid",h.scopedSlots=o,h}},created:function(){var e=this.columns,o=this.proxyColumns,t=this.fetchColumns;o&&t(o),this.tableColumns=e||[]},mounted:function(){},beforeDestroy:function(){},destroyed:function(){},methods:(0,_objectSpread2.default)((0,_objectSpread2.default)({},methods),{},{reload:function(){var e=this.proxyConfig;e&&e.ajax&&e.ajax.query&&this.$refs.dataGrid.commitProxy("reload")},onSearchSubmit:function(e){this.searchData=e,this.$refs.dataGrid.commitProxy("reload")},handleTableQuery:function(e){var o=this.searchData,t=this.pagerConfigOpt,r={};if(t&&e.page){var n=t.props.currentPage;0===t.pageIndex?r[n]=e.page.currentPage-1:t.pageIndex?r[n]=e.page.currentPage-1+t.pageIndex:r[n]=e.page.currentPage,r[t.props.pageSize]=e.page.pageSize}return(0,_objectSpread2.default)((0,_objectSpread2.default)({},o),r)},onButtonActionClick:function(e){var o=this,t=this.searchData;"advancedQuery"===e&&(this.advancedVisible=!0,this.$nextTick(function(){o.$refs.advancedSearch.setData(t)}))},onAdvancedSubmit:function(){var o=this,t=this.$refs,r=this.onAdvancedcancel;t.advancedSearch.validateFields().then(function(e){o.$refs.headSearch.setData(e),o.searchData=e,t.dataGrid.commitProxy("reload"),r()})},onAdvancedcancel:function(){this.advancedVisible=!1},showSetColumns:function(){this.$refs.setColumsModal.show()},setTableColumns:function(e){var o=this.proxyColumns,t=this.fetchColumns;if(e){this.backupColumns=_utils.default.clone(e);var r=o&&o.props&&_utils.default.isObject(o.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),o.props):_conf.default.proxyColumns.props;this.tableColumns=e.filter(function(e){return!1!==e[r.show]})}else o&&t(o)},renderCheckbox:function(o){var e=(new _vue.default).$createElement,t=this.tableColumns[o.columnIndex];return e("a-checkbox",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},t.editRender.props),{},{checked:o.row[o.column.property]}),on:{input:function(e){o.row[o.column.property]=e,t.editRender.on&&t.editRender.on.change&&t.editRender.on.change(o)}}})},renderSwitch:function(o){var e=(new _vue.default).$createElement,t=this.tableColumns[o.columnIndex];return e("a-switch",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},t.editRender.props),{},{checked:o.row[o.column.property]}),on:{change:function(e){o.row[o.column.property]=e,t.editRender.on&&t.editRender.on.change&&t.editRender.on.change(o)}}})},renderPulldownTableView:function(e){var o=(new _vue.default).$createElement,t=e.row[e.column.property],r=this.tableColumns[e.columnIndex],n=r.editRender.props&&r.editRender.props.textField?r.editRender.props.textField:"name",a="";return t&&_utils.default.isArray(t)?a=t.map(function(e){return e[n]}).join(","):t&&_utils.default.isObject(t)?a=t[n]:t&&(a=t),o("div",{},[a])},renderPulldownTable:function(o){var e=(new _vue.default).$createElement,t=this.tableColumns[o.columnIndex];return e("pulldownTable",{props:(0,_objectSpread2.default)({},t.editRender.props),on:{change:function(e){o.row[o.column.property]=e,t.editRender.on&&t.editRender.on.change&&t.editRender.on.change(o)}}})},fetchColumns:function(r){var n=this,a=this.columns;r.ajax&&r.ajax.query&&r.ajax.query().then(function(e){var o=r.props&&_utils.default.isObject(r.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),r.props):_conf.default.proxyColumns.props,t=handleColumnsData(_utils.default.getObjData(o.list,e),a,o);n.backupColumns=_utils.default.clone(t),n.tableColumns=t.filter(function(e){return!1!==e[o.show]})})},onToobarButtonClick:function(e){this.$emit("toobarButtonClick",e)}}),render:function(e){var o=this.tableProps,t=this.headToolbar,r=this.setcolumnsConfig,n=this.height,a=[];(t&&t.tools&&t.tools.setColumns||r)&&a.push(renderColumnsModal(e,this));var s="";return n&&_utils.default.isString(n)&&-1<n.indexOf("calc")&&(s=n),e("div",{class:"data-table"},[renderHeadToolbar(e,this),e("div",{style:{height:s}},[e("vxe-grid",o)])].concat(a))}};exports.default=_default2;