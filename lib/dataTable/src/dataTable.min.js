"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.join"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.search"),require("core-js/modules/web.dom-collections.for-each"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue"));require("vxe-table/lib/index.css");var _utils=_interopRequireDefault(require("../../utils")),_vxeTable=require("vxe-table"),_dataForm=require("../../dataForm"),_conf=_interopRequireDefault(require("../conf")),_setColums=_interopRequireDefault(require("./setColums")),tablePropKeys=Object.keys(_vxeTable.Table.props),methods={};function renderHeadSearch(e,t,o){var r=o.onSearchSubmit,a=o.onButtonActionClick,n=o.$scopedSlots,s=e.items;return t("data-form",{ref:"headSearchForm",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),{},{items:s}),class:"head-search-form",style:e.style,on:(0,_objectSpread2.default)((0,_objectSpread2.default)({submit:r},e.on),{},{buttonActionClick:a}),scopedSlots:n})}function renderHeadToolbarSearch(e,t,o){var r=o.onSearchSubmit,a=o.onButtonActionClick,n=o.$scopedSlots,s=_utils.default.clone(e,!0),i=s.items.filter(function(e){return!e.folding}),l=[];if(!1!==s.submitButtonProps){var u=s.submitButtonProps&&_utils.default.isObject(s.submitButtonProps)?s.submitButtonProps:{};l.push({props:(0,_objectSpread2.default)({action:"submit",content:"查询",type:"primary"},u)})}if(-1<s.items.findIndex(function(e){return e.folding})&&!1!==s.advancedSearchButtonProps){var d=s.advancedSearchButtonProps&&_utils.default.isObject(s.advancedSearchButtonProps)?s.advancedSearchButtonProps:{};l.push({props:(0,_objectSpread2.default)({action:"advancedQuery",content:"高级查询"},d)})}return l&&l.length&&i.push({colon:!1,titleWidth:0,folding:!1,itemRender:{name:"buttons",items:l}}),t("data-form",{ref:"headSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},s),{},{submitButtonProps:!1,items:i}),class:"headtoolbar-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({submit:r},s.on),{},{buttonActionClick:a}),style:(0,_objectSpread2.default)({},s.style),scopedSlots:n})}function renderAdvancedSearch(e,t,o){var r=o.onSearchSubmit,a=o.advancedVisible,n=o.onAdvancedcancel,s=o.onAdvancedSubmit,i=o.$scopedSlots,l=_utils.default.clone(e,!0),u=l.items.filter(function(e){return!1!==e.folding}).map(function(e){return delete e.folding,e}),d=l.advancedSearchForm&&l.advancedSearchForm.props?l.advancedSearchForm.props:{},c=t("data-form",{ref:"advancedSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},d),{},{items:u,submitButtonProps:!1}),class:"advanced-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},l.on),{},{submit:r}),scopedSlots:i}),p=l.advancedSearchModal&&l.advancedSearchModal.props?l.advancedSearchModal.props:{};return t("a-modal",(0,_objectSpread2.default)((0,_objectSpread2.default)({},l.advancedSearchModal),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},p),{},{title:p.title?p.title:"高级查询",visible:a}),on:{cancel:n,ok:s},class:"advanced-search-modal"}),[c])}function renderColumnsModal(e,t){var o=t.backupColumns,r=t.setTableColumns;return e("SetColums",{ref:"setColumsModal",props:{option:t.setColumnsOpt,columns:o},on:{submit:r}})}function renderButton(e,t,o,r){var a=e.name,n=e.icon,s=e.disabled,i=e.code,l=e.on,u=r.onToobarButtonClick,d="";n&&(d=t("a-icon",{props:{type:n}}));var c=function(e){e&&e.target.blur(),u(i),l&&l.click&&l.click(e)};return o?t("a-menu-item",{key:i,props:{disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},l),{},{click:c})},[d,a]):t("a-button",{key:i,props:{type:e.type,disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},l),{},{click:c})},[d,a])}function renderButtons(e,a,n){return e?e.map(function(e){if("[object Array]"===Object.prototype.toString.call(e)){var t=e.map(function(e){return renderButton(e,a,!1,n)});return a("a-button-group",{},[t])}if(e.dropdowns&&e.dropdowns.length){var o=e.dropdowns.map(function(e){return renderButton(e,a,!0,n)}),r=a("a-menu",{slot:"overlay"},[o]);return a("a-dropdown",{props:{disabled:e.disabled},scopedSlots:{overlay:function(){return r}}},[a("a-button",{},[e.name,a("a-icon",{props:{type:"down"}})])])}if("[object Object]"===Object.prototype.toString.call(e))return renderButton(e,a,!1,n)}):[]}function renderHeadToolbar(e,t){var o=t.headToolbar,r=t.$nextTick,a=t.$refs,n=t.showSetColumns,s=t.setcolumnsConfig,i=t.$slots;if(!o)return!1;var l={ref:"headToolbar",props:{},class:"head-toolbar",scopedSlots:{}},u="";if(i.headToolbar_buttons)u=i.headToolbar_buttons;else if(o.buttons){var d=renderButtons(o.buttons,e,t);u=d}u&&(o.search&&"left"===o.search.position?l.scopedSlots.tools=function(){return u}:l.scopedSlots.buttons=function(){return u});var c="",p="";o.search&&(p=renderHeadToolbarSearch(o.search,e,t),c=renderAdvancedSearch(o.search,e,t)),p&&("left"===o.search.position?l.scopedSlots.buttons=function(){return p}:l.scopedSlots.tools=function(){return p});var f="";if(o.tools){if(l.props=(0,_objectSpread2.default)({},o.tools),o.tools.setColumns){var h=_utils.default.isObject(o.tools.setColumns)?o.tools.setColumns:{},b=e("a-button",{props:(0,_objectSpread2.default)({circle:!0,icon:"setting",shape:"circle"},h),class:"tool-btn-setcolumns",style:{marginRight:"10px"},on:{click:n}});l.scopedSlots.tools=p?function(){return e("div",{style:{display:"flex"}},[p,b])}:function(){return b},s||(f=renderColumnsModal(e,t))}r(function(){a.dataGrid.connect(a.headToolbar)})}return e("div",{class:"head-toolbar-box"},[e("vxe-toolbar",l,[]),c,f])}function handleColumnsData(e,t,n){var s=_utils.default.clone(t),o=e.map(function(e){var t=(0,_objectSpread2.default)({},e);for(var o in n)"list"!==o&&(t[o]=e[n[o]]);if(s&&s.length){var r=s.findIndex(function(e){return e.field===t.field});if(-1<r){var a=s[r];t=(0,_objectSpread2.default)((0,_objectSpread2.default)({},t),a),s.splice(r,1)}}return t.children&&t.children.length&&(t.children=handleColumnsData(t.children,t.children,n)),t});s&&s.length&&(s=s.map(function(e){return e.colIndex||0===e.colIndex?(o.splice(e.colIndex,0,e),""):e}).filter(function(e){return""!=e}));return s&&s.length?o.concat(s):o}Object.keys(_vxeTable.Table.methods).forEach(function(t){methods[t]=function(){var e;return this.$refs.dataGrid&&(e=this.$refs.dataGrid)[t].apply(e,arguments)}});var _default2={name:"DataTable",components:{DataForm:_dataForm.DataForm,SetColums:_setColums.default},props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_vxeTable.Table.props),{},{columns:Array,pagerConfig:{type:[Boolean,Object],default:function(){}},proxyConfig:Object,toolbar:[Boolean,Object],formConfig:[Boolean,Object],zoomConfig:Object,searchConfig:Object,headToolbar:Object,setcolumnsConfig:Object,proxyColumns:Object,highlightCurrentUnselect:Boolean}),watch:{columns:function(e){this.setTableColumns(e)}},data:function(){return{backupColumns:[],tableColumns:[],advancedVisible:!1,searchData:{},tableHeight:"",currentRow:{}}},computed:{tableExtendProps:function(){var t=this,o={};return tablePropKeys.forEach(function(e){o[e]=t[e]}),o},pagerConfigOpt:function(){return this.pagerConfig?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.pagerConfig),this.pagerConfig):!this.pagerConfig&&!1!==this.pagerConfig&&_conf.default.pagerConfig},setColumnsOpt:function(){if(this.setcolumnsConfig){var e=this.setcolumnsConfig&&this.setcolumnsConfig.modal&&this.setcolumnsConfig.modal.props?this.setcolumnsConfig.modal.props:{},t=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.props?this.setcolumnsConfig.proxyConfig.props:{},o=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.ajax?this.setcolumnsConfig.proxyConfig.ajax:{};return{modal:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.modal.props),e)},proxyConfig:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.props),t),ajax:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.ajax),o)}}}return _conf.default.setColumns},proxyConfigOpt:function(){if(this.proxyConfig){var e=this.proxyConfig&&this.proxyConfig.props?this.proxyConfig.props:{};return(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig),this.proxyConfig),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.props),e)})}},tableProps:function(){var a=this,e=this.$listeners,t=this.$scopedSlots,o=this.tableExtendProps,r=this.handleTableQuery,n=this.tableColumns,s=this.renderCheckbox,i=this.pagerConfigOpt,l=this.proxyConfigOpt,u=this.renderPulldownTable,d=this.renderPulldownTableView,c=this.renderSwitch,p=this.height,f=this.highlightCurrentUnselect,h=this.onCurrentRowCellClick,b=this.onCurrentRowChange,m=this.$options.propsData,g=Object.assign({},o),S=n.map(function(e){return e.editRender&&e.editRender.name&&"ACheckbox"===e.editRender.name?(e.slots={default:"a_checkbox",edit:"a_checkbox"},a.$scopedSlots.a_checkbox=s):e.editRender&&e.editRender.name&&"ASwitch"===e.editRender.name?(e.slots={default:"a_switch",edit:"a_switch"},a.$scopedSlots.a_switch=c):e.editRender&&e.editRender.name&&"pulldownTable"===e.editRender.name&&(e.slots={default:"pulldownTableView",edit:"pulldownTable"},a.$scopedSlots.pulldownTableView=d,a.$scopedSlots.pulldownTable=u),e});Object.assign(g,{props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.props),m),{},{proxyConfig:_utils.default.clone(l,!0),columns:S,loading:m.loading})}),p&&_utils.default.isString(p)&&-1<p.indexOf("calc")&&(g.props.height="auto");var _={};_utils.default.each(e,function(e,r){_[r]=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];a.$emit.apply(a,[r].concat(t))}});var C=!1;return l&&l.ajax&&l.ajax.query&&(C=!0,g.props.proxyConfig.ajax.query=function(e){var t=r(e);return!1!==t&&(t&&(e=t),l.ajax.query(e))}),!1!==g.props.pagerConfig&&C&&(g.props.pagerConfig=i),f&&(_["cell-click"]=h,_["current-change"]=b),g.on=_,g.ref="dataGrid",g.scopedSlots=t,g}},created:function(){var e=this.columns,t=this.proxyColumns,o=this.fetchColumns;t&&o(t),this.tableColumns=e||[]},mounted:function(){},beforeDestroy:function(){},destroyed:function(){},methods:(0,_objectSpread2.default)((0,_objectSpread2.default)({},methods),{},{reload:function(e){var t=this.proxyConfig;t&&t.ajax&&t.ajax.query&&(e&&(this.searchData=(0,_objectSpread2.default)((0,_objectSpread2.default)({},this.searchData),e)),this.$refs.dataGrid.commitProxy("reload"))},onSearchSubmit:function(e){this.searchData=e,this.reload()},handleTableQuery:function(e){var t=this.searchData,o=this.pagerConfigOpt,r={};if(o&&e.page){var a=o.props.currentPage;0===o.pageIndex?r[a]=e.page.currentPage-1:o.pageIndex?r[a]=e.page.currentPage-1+o.pageIndex:r[a]=e.page.currentPage,r[o.props.pageSize]=e.page.pageSize}else r=e&&e.$grid?{}:e;return(0,_objectSpread2.default)((0,_objectSpread2.default)({},t),r)},onButtonActionClick:function(e,t){var o=this,r=this.searchData;"advancedQuery"===e&&(t&&t.target.blur(),this.advancedVisible=!0,this.$nextTick(function(){o.$refs.advancedSearch.setData(r)}))},onAdvancedSubmit:function(){var t=this,e=this.$refs,o=this.onAdvancedcancel;e.advancedSearch.validateFields().then(function(e){t.$refs.headSearch.setData(e),t.searchData=e,t.reload(),o()})},onAdvancedcancel:function(){this.advancedVisible=!1},showSetColumns:function(){this.$refs.setColumsModal.show()},setTableColumns:function(e){var t=this.proxyColumns,o=this.fetchColumns;if(e){this.backupColumns=_utils.default.clone(e);var r=t&&t.props&&_utils.default.isObject(t.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),t.props):_conf.default.proxyColumns.props;this.tableColumns=e.filter(function(e){return!1!==e[r.show]})}else t&&o(t)},renderCheckbox:function(t){var e=(new _vue.default).$createElement,o=this.tableColumns[t.columnIndex];return e("a-checkbox",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},o.editRender.props),{},{checked:t.row[t.column.property]}),on:{input:function(e){t.row[t.column.property]=e,o.editRender.on&&o.editRender.on.change&&o.editRender.on.change(t)}}})},renderSwitch:function(t){var e=(new _vue.default).$createElement,o=this.tableColumns[t.columnIndex];return e("a-switch",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},o.editRender.props),{},{checked:t.row[t.column.property]}),on:{change:function(e){t.row[t.column.property]=e,o.editRender.on&&o.editRender.on.change&&o.editRender.on.change(t)}}})},renderPulldownTableView:function(e){var t=(new _vue.default).$createElement,o=e.row[e.column.property],r=this.tableColumns[e.columnIndex],a=r.editRender.props&&r.editRender.props.textField?r.editRender.props.textField:"name",n="";return o&&_utils.default.isArray(o)?n=o.map(function(e){return e[a]}).join(","):o&&_utils.default.isObject(o)?n=o[a]:o&&(n=o),t("div",{},[n])},renderPulldownTable:function(t){var e=(new _vue.default).$createElement,o=this.tableColumns[t.columnIndex];return e("pulldownTable",{props:(0,_objectSpread2.default)({},o.editRender.props),on:{change:function(e){t.row[t.column.property]=e,o.editRender.on&&o.editRender.on.change&&o.editRender.on.change(t)}}})},fetchColumns:function(r){var a=this,n=this.columns;r.ajax&&r.ajax.query&&r.ajax.query().then(function(e){var t=r.props&&_utils.default.isObject(r.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),r.props):_conf.default.proxyColumns.props,o=handleColumnsData(_utils.default.getObjData(t.list,e),n,t);a.backupColumns=_utils.default.clone(o),a.tableColumns=o.filter(function(e){return!1!==e[t.show]})})},onToobarButtonClick:function(e){this.$emit("toobarButtonClick",e)},setSearchData:function(e){var t=this.$refs.headSearchForm;t&&t.setData&&t.setData(e);var o=this.$refs.headSearch;o&&o.setData&&o.setData(e),this.searchData=e},getSearchData:function(){return this.searchData},onCurrentRowChange:function(e){var t=this;setTimeout(function(){t.currentRow=e.row},10),this.$emit("current-change",e)},onCurrentRowCellClick:function(e){this.currentRow._XID&&e.row._XID===this.currentRow._XID&&(this.$refs.dataGrid.clearCurrentRow(),this.currentRow={},this.$emit("current-change",(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),{},{row:null}))),this.$emit("cell-click",e)}}),render:function(e){var t=this.tableProps,o=this.headToolbar,r=this.setcolumnsConfig,a=this.height,n=this.searchConfig,s=[];(o&&o.tools&&o.tools.setColumns||r)&&s.push(renderColumnsModal(e,this));var i="";a&&_utils.default.isString(a)&&-1<a.indexOf("calc")&&(i=a);var l="";return n&&(l=renderHeadSearch(n,e,this)),e("div",{class:"data-table"},[l,renderHeadToolbar(e,this),e("div",{style:{height:i}},[e("vxe-grid",(0,_objectSpread2.default)({},t))])].concat(s))}};exports.default=_default2;