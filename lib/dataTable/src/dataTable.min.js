"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.join"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.search"),require("core-js/modules/web.dom-collections.for-each"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue"));require("vxe-table/lib/index.css");var _utils=_interopRequireDefault(require("../../utils")),_vxeTable=require("vxe-table"),_dataForm=require("../../dataForm"),_conf=_interopRequireDefault(require("../conf")),_setColums=_interopRequireDefault(require("./setColums")),tablePropKeys=Object.keys(_vxeTable.Table.props),methods={};function renderHeadSearch(e,t,o){var r=o.onSearchSubmit,n=o.onButtonActionClick,a=o.$scopedSlots,s=e.items;return t("data-form",{ref:"headSearchForm",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),{},{items:s}),class:"head-search-form",style:e.style,on:(0,_objectSpread2.default)((0,_objectSpread2.default)({submit:r},e.on),{},{buttonActionClick:n}),scopedSlots:a})}function renderHeadToolbarSearch(e,t,o){var r=o.onSearchSubmit,n=o.onButtonActionClick,a=o.$scopedSlots,s=_utils.default.clone(e,!0),i=s.items.filter(function(e){return!e.folding}),u=[];if(!1!==s.submitButtonProps){var l=s.submitButtonProps&&_utils.default.isObject(s.submitButtonProps)?s.submitButtonProps:{};u.push({props:(0,_objectSpread2.default)({action:"submit",content:"查询",type:"primary"},l)})}if(-1<s.items.findIndex(function(e){return e.folding})&&!1!==s.advancedSearchButtonProps){var c=s.advancedSearchButtonProps&&_utils.default.isObject(s.advancedSearchButtonProps)?s.advancedSearchButtonProps:{};u.push({props:(0,_objectSpread2.default)({action:"advancedQuery",content:"高级查询"},c)})}return u&&u.length&&i.push({colon:!1,titleWidth:0,folding:!1,itemRender:{name:"buttons",items:u}}),t("data-form",{ref:"headSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},s),{},{submitButtonProps:!1,items:i}),class:"headtoolbar-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({submit:r},s.on),{},{buttonActionClick:n}),scopedSlots:a})}function renderAdvancedSearch(e,t,o){var r=o.onSearchSubmit,n=o.advancedVisible,a=o.onAdvancedcancel,s=o.onAdvancedSubmit,i=o.$scopedSlots,u=_utils.default.clone(e,!0),l=u.items.filter(function(e){return!1!==e.folding}).map(function(e){return delete e.folding,e}),c=u.advancedSearchForm&&u.advancedSearchForm.props?u.advancedSearchForm.props:{},d=t("data-form",{ref:"advancedSearch",props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},c),{},{items:l,submitButtonProps:!1}),class:"advanced-search-form",on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},u.on),{},{submit:r}),scopedSlots:i}),p=u.advancedSearchModal&&u.advancedSearchModal.props?u.advancedSearchModal.props:{};return t("a-modal",(0,_objectSpread2.default)((0,_objectSpread2.default)({},u.advancedSearchModal),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},p),{},{title:p.title?p.title:"高级查询",visible:n}),on:{cancel:a,ok:s},class:"advanced-search-modal"}),[d])}function renderColumnsModal(e,t){var o=t.backupColumns,r=t.setTableColumns;return e("SetColums",{ref:"setColumsModal",props:{option:t.setColumnsOpt,columns:o},on:{submit:r}})}function renderButton(e,t,o,r){var n=e.name,a=e.icon,s=e.disabled,i=e.code,u=e.on,l=r.onToobarButtonClick,c="";a&&(c=t("a-icon",{props:{type:a}}));var d=function(e){l(i),u&&u.click&&u.click(e)};return o?t("a-menu-item",{key:i,props:{disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},u),{},{click:d})},[c,n]):t("a-button",{key:i,props:{type:e.type,disabled:s},on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},u),{},{click:d})},[c,n])}function renderButtons(e,n,a){return e?e.map(function(e){if("[object Array]"===Object.prototype.toString.call(e)){var t=e.map(function(e){return renderButton(e,n,!1,a)});return n("a-button-group",{},[t])}if(e.dropdowns&&e.dropdowns.length){var o=e.dropdowns.map(function(e){return renderButton(e,n,!0,a)}),r=n("a-menu",{slot:"overlay"},[o]);return n("a-dropdown",{props:{disabled:e.disabled},scopedSlots:{overlay:function(){return r}}},[n("a-button",{},[e.name,n("a-icon",{props:{type:"down"}})])])}if("[object Object]"===Object.prototype.toString.call(e))return renderButton(e,n,!1,a)}):[]}function renderHeadToolbar(e,t){var o=t.headToolbar,r=t.$nextTick,n=t.$refs,a=t.showSetColumns,s=t.setcolumnsConfig,i=t.$slots;if(!o)return!1;var u={ref:"headToolbar",props:{},class:"head-toolbar",scopedSlots:{}},l="";if(i.headToolbar_buttons)l=i.headToolbar_buttons;else if(o.buttons){var c=renderButtons(o.buttons,e,t);l=c}l&&(o.search&&"left"===o.search.position?u.scopedSlots.tools=function(){return l}:u.scopedSlots.buttons=function(){return l});var d="",p="";o.search&&(p=renderHeadToolbarSearch(o.search,e,t),d=renderAdvancedSearch(o.search,e,t)),p&&("left"===o.search.position?u.scopedSlots.buttons=function(){return p}:u.scopedSlots.tools=function(){return p});var f="";if(o.tools){if(u.props=(0,_objectSpread2.default)({},o.tools),o.tools.setColumns){var h=_utils.default.isObject(o.tools.setColumns)?o.tools.setColumns:{},b=e("a-button",{props:(0,_objectSpread2.default)({circle:!0,icon:"setting",shape:"circle"},h),class:"tool-btn-setcolumns",style:{marginRight:"10px"},on:{click:a}});u.scopedSlots.tools=p?function(){return e("div",{style:{display:"flex"}},[p,b])}:function(){return b},s||(f=renderColumnsModal(e,t))}r(function(){n.dataGrid.connect(n.headToolbar)})}return e("div",{class:"head-toolbar-box"},[e("vxe-toolbar",u,[]),d,f])}function handleColumnsData(e,t,a){var s=_utils.default.clone(t),o=e.map(function(e){var t=(0,_objectSpread2.default)({},e);for(var o in a)"list"!==o&&(t[o]=e[a[o]]);if(s&&s.length){var r=s.findIndex(function(e){return e.field===t.field});if(-1<r){var n=s[r];t=(0,_objectSpread2.default)((0,_objectSpread2.default)({},t),n),s.splice(r,1)}}return t.children&&t.children.length&&(t.children=handleColumnsData(t.children,t.children,a)),t});s&&s.length&&(s=s.map(function(e){return e.colIndex||0===e.colIndex?(o.splice(e.colIndex,0,e),""):e}).filter(function(e){return""!=e}));return s&&s.length?o.concat(s):o}Object.keys(_vxeTable.Table.methods).forEach(function(t){methods[t]=function(){var e;return this.$refs.dataGrid&&(e=this.$refs.dataGrid)[t].apply(e,arguments)}});var _default2={name:"DataTable",components:{DataForm:_dataForm.DataForm,SetColums:_setColums.default},props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_vxeTable.Table.props),{},{columns:Array,pagerConfig:{type:[Boolean,Object],default:function(){}},proxyConfig:Object,toolbar:[Boolean,Object],formConfig:[Boolean,Object],zoomConfig:Object,searchConfig:Object,headToolbar:Object,setcolumnsConfig:Object,proxyColumns:Object,highlightCurrentUnselect:Boolean}),watch:{columns:function(e){this.setTableColumns(e)}},data:function(){return{backupColumns:[],tableColumns:[],advancedVisible:!1,searchData:{},tableHeight:"",currentRow:{}}},computed:{tableExtendProps:function(){var t=this,o={};return tablePropKeys.forEach(function(e){o[e]=t[e]}),o},pagerConfigOpt:function(){return this.pagerConfig?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.pagerConfig),this.pagerConfig):!this.pagerConfig&&!1!==this.pagerConfig&&_conf.default.pagerConfig},setColumnsOpt:function(){if(this.setcolumnsConfig){var e=this.setcolumnsConfig&&this.setcolumnsConfig.modal&&this.setcolumnsConfig.modal.props?this.setcolumnsConfig.modal.props:{},t=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.props?this.setcolumnsConfig.proxyConfig.props:{},o=this.setcolumnsConfig&&this.setcolumnsConfig.proxyConfig&&this.setcolumnsConfig.proxyConfig.ajax?this.setcolumnsConfig.proxyConfig.ajax:{};return{modal:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.modal.props),e)},proxyConfig:{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.props),t),ajax:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.setColumns.proxyConfig.ajax),o)}}}return _conf.default.setColumns},proxyConfigOpt:function(){if(this.proxyConfig){var e=this.proxyConfig&&this.proxyConfig.props?this.proxyConfig.props:{};return(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig),this.proxyConfig),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.props),e)})}},tableProps:function(){var n=this,e=this.$listeners,t=this.$scopedSlots,o=this.tableExtendProps,r=this.handleTableQuery,a=this.tableColumns,s=this.renderCheckbox,i=this.pagerConfigOpt,u=this.proxyConfigOpt,l=this.renderPulldownTable,c=this.renderPulldownTableView,d=this.renderSwitch,p=this.height,f=this.highlightCurrentUnselect,h=this.onCurrentRowCellClick,b=this.onCurrentRowChange,m=this.$options.propsData,g=Object.assign({},o),S=a.map(function(e){return e.editRender&&e.editRender.name&&"ACheckbox"===e.editRender.name?(e.slots={default:"a_checkbox",edit:"a_checkbox"},n.$scopedSlots.a_checkbox=s):e.editRender&&e.editRender.name&&"ASwitch"===e.editRender.name?(e.slots={default:"a_switch",edit:"a_switch"},n.$scopedSlots.a_switch=d):e.editRender&&e.editRender.name&&"pulldownTable"===e.editRender.name&&(e.slots={default:"pulldownTableView",edit:"pulldownTable"},n.$scopedSlots.pulldownTableView=c,n.$scopedSlots.pulldownTable=l),e});Object.assign(g,{props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.props),m),{},{proxyConfig:u,columns:S})}),p&&_utils.default.isString(p)&&-1<p.indexOf("calc")&&(g.props.height="auto");var C={};_utils.default.each(e,function(e,r){C[r]=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];n.$emit.apply(n,[r].concat(t))}});var _=!1;if(g.props.proxyConfig&&g.props.proxyConfig.ajax&&g.props.proxyConfig.ajax.query){_=!0;var j=g.props.proxyConfig.ajax.query;g.props.proxyConfig.ajax.query=function(e){var t=r(e);return!1!==t&&(t&&(e=t),j(e))}}return!1!==g.props.pagerConfig&&_&&(g.props.pagerConfig=i),f&&(C["cell-click"]=h,C["current-change"]=b),g.on=C,g.ref="dataGrid",g.scopedSlots=t,g}},created:function(){var e=this.columns,t=this.proxyColumns,o=this.fetchColumns;t&&o(t),this.tableColumns=e||[]},mounted:function(){},beforeDestroy:function(){},destroyed:function(){},methods:(0,_objectSpread2.default)((0,_objectSpread2.default)({},methods),{},{reload:function(e){var t=this.proxyConfig;t&&t.ajax&&t.ajax.query&&(e&&(this.searchData=(0,_objectSpread2.default)((0,_objectSpread2.default)({},this.searchData),e)),this.$refs.dataGrid.commitProxy("reload"))},onSearchSubmit:function(e){this.searchData=e,this.reload()},handleTableQuery:function(e){var t=this.searchData,o=this.pagerConfigOpt,r={};if(o&&e.page){var n=o.props.currentPage;0===o.pageIndex?r[n]=e.page.currentPage-1:o.pageIndex?r[n]=e.page.currentPage-1+o.pageIndex:r[n]=e.page.currentPage,r[o.props.pageSize]=e.page.pageSize}return(0,_objectSpread2.default)((0,_objectSpread2.default)({},t),r)},onButtonActionClick:function(e){var t=this,o=this.searchData;"advancedQuery"===e&&(this.advancedVisible=!0,this.$nextTick(function(){t.$refs.advancedSearch.setData(o)}))},onAdvancedSubmit:function(){var t=this,e=this.$refs,o=this.onAdvancedcancel;e.advancedSearch.validateFields().then(function(e){t.$refs.headSearch.setData(e),t.searchData=e,t.reload(),o()})},onAdvancedcancel:function(){this.advancedVisible=!1},showSetColumns:function(){this.$refs.setColumsModal.show()},setTableColumns:function(e){var t=this.proxyColumns,o=this.fetchColumns;if(e){this.backupColumns=_utils.default.clone(e);var r=t&&t.props&&_utils.default.isObject(t.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),t.props):_conf.default.proxyColumns.props;this.tableColumns=e.filter(function(e){return!1!==e[r.show]})}else t&&o(t)},renderCheckbox:function(t){var e=(new _vue.default).$createElement,o=this.tableColumns[t.columnIndex];return e("a-checkbox",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},o.editRender.props),{},{checked:t.row[t.column.property]}),on:{input:function(e){t.row[t.column.property]=e,o.editRender.on&&o.editRender.on.change&&o.editRender.on.change(t)}}})},renderSwitch:function(t){var e=(new _vue.default).$createElement,o=this.tableColumns[t.columnIndex];return e("a-switch",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},o.editRender.props),{},{checked:t.row[t.column.property]}),on:{change:function(e){t.row[t.column.property]=e,o.editRender.on&&o.editRender.on.change&&o.editRender.on.change(t)}}})},renderPulldownTableView:function(e){var t=(new _vue.default).$createElement,o=e.row[e.column.property],r=this.tableColumns[e.columnIndex],n=r.editRender.props&&r.editRender.props.textField?r.editRender.props.textField:"name",a="";return o&&_utils.default.isArray(o)?a=o.map(function(e){return e[n]}).join(","):o&&_utils.default.isObject(o)?a=o[n]:o&&(a=o),t("div",{},[a])},renderPulldownTable:function(t){var e=(new _vue.default).$createElement,o=this.tableColumns[t.columnIndex];return e("pulldownTable",{props:(0,_objectSpread2.default)({},o.editRender.props),on:{change:function(e){t.row[t.column.property]=e,o.editRender.on&&o.editRender.on.change&&o.editRender.on.change(t)}}})},fetchColumns:function(r){var n=this,a=this.columns;r.ajax&&r.ajax.query&&r.ajax.query().then(function(e){var t=r.props&&_utils.default.isObject(r.props)?(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyColumns.props),r.props):_conf.default.proxyColumns.props,o=handleColumnsData(_utils.default.getObjData(t.list,e),a,t);n.backupColumns=_utils.default.clone(o),n.tableColumns=o.filter(function(e){return!1!==e[t.show]})})},onToobarButtonClick:function(e){this.$emit("toobarButtonClick",e)},setSearchData:function(e){var t=this.$refs.headSearchForm;t&&t.setData&&t.setData(e);var o=this.$refs.headSearch;o&&o.setData&&o.setData(e),this.searchData=e},getSearchData:function(){return this.searchData},onCurrentRowChange:function(e){var t=this;setTimeout(function(){t.currentRow=e.row},10),this.$emit("current-change",e)},onCurrentRowCellClick:function(e){this.currentRow._XID&&e.row._XID===this.currentRow._XID&&(this.$refs.dataGrid.clearCurrentRow(),this.currentRow={},this.$emit("current-change",(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),{},{row:null}))),this.$emit("cell-click",e)}}),render:function(e){var t=this.tableProps,o=this.headToolbar,r=this.setcolumnsConfig,n=this.height,a=this.searchConfig,s=[];(o&&o.tools&&o.tools.setColumns||r)&&s.push(renderColumnsModal(e,this));var i="";n&&_utils.default.isString(n)&&-1<n.indexOf("calc")&&(i=n);var u="";return a&&(u=renderHeadSearch(a,e,this)),e("div",{class:"data-table"},[u,renderHeadToolbar(e,this),e("div",{style:{height:i}},[e("vxe-grid",(0,_objectSpread2.default)({},t))])].concat(s))}};exports.default=_default2;