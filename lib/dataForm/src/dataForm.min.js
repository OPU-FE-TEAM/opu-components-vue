"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.map"),require("core-js/modules/es.function.name"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/es.string.split"),require("core-js/modules/web.dom-collections.for-each"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/defineProperty")),_objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2"));require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/asyncToGenerator")),_utils=_interopRequireDefault(require("../../utils")),_index=_interopRequireDefault(require("./index")),_conf=_interopRequireDefault(require("../conf")),_enquire=_interopRequireDefault(require("enquire.js")),_actionModal=_interopRequireDefault(require("./actionModal")),optionsComponents=["a-radio-group","a-checkbox-group","a-cascader"];function nextItemFocus(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=t.enterToNextItemFocusList,o=t.setFieldFocus;if(e.itemRender&&e.itemRender.on&&e.itemRender.on.enter&&0==e.itemRender.on.enter(n))return;var r=i.indexOf(e.field);-1<r&&r<i.length-1&&o(i[r+1])}function handeUnifyApiGetOptions(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},i=4<arguments.length?arguments[4]:void 0,o=n.getSelectOptions,s={},a=[];e.map(function(e){var t=e.itemRender.props,n=t.param,i=t.autoLoadOptionsId;for(var o in a.push({field:e.field,param:n}),n)s[o]&&_utils.default.isArray(s[o])?s[o].push(n[o]):s[o]&&!_utils.default.isArray(s[o])?s[o]=[s[o],n[o]]:s[o]=n[o];r&&r[e.field]&&_conf.default.getSelectOptions&&_conf.default.getSelectOptions.loadOptionsIdField&&!1!==i&&(s[_conf.default.getSelectOptions.loadOptionsIdField]=r[e.field])});var l=o&&o.api?o.api:_conf.default.getSelectOptions.api;l&&t.push({api:l,param:s,fields:a}),fetchItemPropsOptionsApiList(t,n,r,i)}var fetchItemPropsOptionsApiList=function(){var o=(0,_asyncToGenerator2.default)(regeneratorRuntime.mark(function e(t,l,i,n){var o,r,s,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=l.setFieldsOptions,r=l.onOptionsAllLoad,!(s=l.onOptionsLoadBefore)){e.next=8;break}if(!1===(a=s(t)))return e.abrupt("return",!1);e.next=7;break;case 7:a&&(t=a);case 8:u=t.map(function(e){var t=e.api,n=e.param;return e.field&&i&&i[e.field]&&_conf.default.getSelectOptions&&_conf.default.getSelectOptions.loadOptionsIdField&&(e.props&&!1!==e.props.autoLoadOptionsId||!e.props)&&(n[_conf.default.getSelectOptions.loadOptionsIdField]=i[e.field]),t(n)}),Promise.all(u).then(function(s){var a={};if(t.forEach(function(e,t){var n=e.field,i=e.fields,o=s[t];if(i&&i.length)i.forEach(function(e){var t=handlefieldOptionsDataField(e.field,o,l);a[e.field]=t});else{var r=handlefieldOptionsDataField(n,o,l);a[n]=r}}),o(a),r){var e=r(a);e&&(a=e)}n&&n()}).catch(function(){});case 10:case"end":return e.stop()}},e)}));return function(e,t,n,i){return o.apply(this,arguments)}}();function handlefieldOptionsDataField(t,e,n){var i=n.itemsOptions.find(function(e){return e.field===t}),o=e;if(i&&i.itemRender&&i.itemRender.props){var r=i.itemRender.props,s=null!=r.dataField?r.dataField:_conf.default.getSelectOptions.dataField;o=_utils.default.getObjData(s,e)}return o}function renderItemTitle(e,t,n){var i=n.titleColon,o=n.titleWidth,r=n.titleAlign,s=!1;if(e.option&&e.option.rules&&e.option.rules.length)for(var a=0;a<e.option.rules.length;a++){if(e.option.rules[a].required){s=!0;break}}var l="";l="function"==typeof e.title?[e.title()]:e.title;var u=e.titleWidth||0===e.titleWidth?e.titleWidth:o;_utils.default.isNumber(u)&&(u="".concat(u,"px"));var d="";return e.tooltip&&(d=t("a-tooltip",{props:{title:e.tooltip},style:{marginLeft:"5px"}},[t("a-icon",{props:{type:"question-circle"},style:{color:"#999"}})])),t("div",{class:["data-form-item-title",r,{colon:!1===e.colon?e.colon:i},{required:s}],style:{width:u}},[l,d])}function renderItemInput(t,e,n){var i=n.$slots,o=n.$scopedSlots,r=n.readonly,s=n.onButtonClick,a=n.items,l=[t.field];t.option&&l.push(t.option);var u=(0,_objectSpread2.default)((0,_objectSpread2.default)({props:{fieldName:t.field}},t.itemRender),{},{ref:"input_"+t.field,directives:[{name:"decorator",value:l}]});if(r||t.itemRender&&t.itemRender.props&&t.itemRender.props.readonly)u.class?_utils.default.isArray(u.class)?u.class.push("input_readonly"):_utils.default.isString(u.class)&&(u.class="".concat(u.class," input_readonly")):u.class=["input_readonly"],u.props?(u.props.disabled=!0,u.props.placeholder=null):u.props={disabled:!0,placeholder:""};else{var d=a.find(function(e){return e.field===t.field});d&&d.itemRender&&d.itemRender.props&&d.itemRender.props.disabled?u.props.disabled=d.itemRender.props.disabled:u.props.disabled=!1}var p="";if(t.itemRender&&t.itemRender.slot)i[t.itemRender.slot]?p=i[t.itemRender.slot]:o[t.itemRender.slot]&&(u.scopedSlots={default:o[t.itemRender.slot]},p=e("a-scopedSlots",u));else if(t.itemRender&&t.itemRender.customRender)t.itemRender&&t.itemRender.props?u.props.customRender=t.itemRender.customRender:u.props={customRender:t.itemRender.customRender},p=e("a-customRender",u);else{var c=t.itemRender&&t.itemRender.name&&"hidden"!==t.itemRender.name?"".concat(t.itemRender.name):"a-input";if(-1<c.indexOf("a-")){var f="";f=c.split("a-")[1],f=_utils.default.lineToUpperCase(f,"-");var m=_conf.default.defaultProps[f]?_conf.default.defaultProps[f]:{};u.props=(0,_objectSpread2.default)((0,_objectSpread2.default)({},m),u.props)}"buttons"===c?(u.props?u.props.itemClick=s:u.props={itemClick:s},u.props.items=t.itemRender.items):"a-select"==c?c="opu-select":"a-date-picker"===c?(c="opu-date-picker",u.on&&_utils.default.isObject(u.on)?u.on.inputPressEnter=function(e){nextItemFocus(t,n,e)}:u.on={inputPressEnter:function(e){nextItemFocus(t,n,e)}}):"a-time-picker"===c?(c="opu-time-picker",u.on&&_utils.default.isObject(u.on)?u.on.inputPressEnter=function(e){nextItemFocus(t,n,e)}:u.on={inputPressEnter:function(e){nextItemFocus(t,n,e)}}):"a-range-picker-split"===c?u.on&&_utils.default.isObject(u.on)?u.on.inputPressEnter=function(e){nextItemFocus(t,n,e)}:u.on={inputPressEnter:function(e){nextItemFocus(t,n,e)}}:"a-input-number-split"===c?u.on&&_utils.default.isObject(u.on)?u.on.inputPressEnter=function(e){nextItemFocus(t,n,e)}:u.on={inputPressEnter:function(e){nextItemFocus(t,n,e)}}:"a-switch"===c?c="opu-switch":"a-checkbox"===c?c="opu-checkbox":"a-tree-select"===c?c="opu-tree-select":"a-select-group"===c?c="opu-select-group":optionsComponents.includes(c)&&(u.props.componentPropsData=u.props,u.props.renderName=c,c="options-component"),p=e(c,u)}return p}function renderItemContent(e,r,t){var n=t.titleWidth,s=t.$scopedSlots,i=e.itemRender&&e.itemRender.before?e.itemRender.before():"",o=e.itemRender&&e.itemRender.after?e.itemRender.after():"";return e.actions&&e.actions.length&&(o=e.actions.map(function(n){var e="";if(_utils.default.isFunction(n.button))e=n.button();else{var t=n.button&&n.button.props?_utils.default.clone(n.button.props):{},i=t.content?t.content:"",o={click:function(e){if(n.button&&n.button.on&&n.button.on.click&&!1===n.button.on.click(e))return!1;if(n.modal){var t=n.modal&&n.modal.props?n.modal.props:{};(0,_actionModal.default)({modalProps:(0,_objectSpread2.default)({},t),content:n.modal.content,form:n.modal.form,slots:s})}}};e=r("a-button",(0,_objectSpread2.default)({},{props:(0,_objectSpread2.default)({},t),on:(0,_objectSpread2.default)({},o),style:(0,_objectSpread2.default)({},n.button.style)}),[i])}return e})),r("div",{style:{width:n},class:"data-form-item-content"},[r("div",{class:"data-form-item-before"},[i]),r("div",{class:"data-form-item-input"},[renderItemInput(e,r,t)]),r("div",{class:"data-form-item-after"},[o])])}function renderItems(s,a){var e=a.itemsOptions,l=a.$slots,u=a.layout,d=a.currentColspan,p=a.$scopedSlots,c=a.focusItemTypes;return e?e.map(function(n){var e={key:n.field,props:n,style:{},class:n.class,scopedSlots:{}},t="";if(n.slot&&l[n.slot])t=l[n.slot];else if(n.slot&&p[n.slot]){var i=[n.field];n.option&&i.push(n.option),t=s("a-scopedSlots",{props:{fieldName:n.field},scopedSlots:{default:p[n.slot]},directives:[{name:"decorator",value:i}]})}else n.itemRender&&"hidden"===n.itemRender.name?(t=[renderItemContent(n,s,a)],e.style.display="none"):(e.scopedSlots.label=function(){return renderItemTitle(n,s,a)},t=[renderItemContent(n,s,a)]);if("grid"===u)n.colspan&&1<n.colspan&&(e.style.gridColumn="span "+n.colspan),n.rowspan&&1<n.rowspan&&(e.style.gridRow="span "+n.rowspan);else if("flex"===u){var o=100/d;n.width?e.style.width=n.width:n.colspan&&1<n.colspan?e.style.width="".concat(o*n.colspan,"%"):e.style.width="".concat(o,"%")}var r={class:["data-form-item-wrapper",n.align],on:{}};return!(n.itemRender&&c.includes(n.itemRender.name)||!n.itemRender)&&n.itemRender.name||n.itemRender&&"a-input-number-split"==n.itemRender.name||(r.on.keyup=function(e){var t=e.keyCode;e.stopPropagation(),13===t&&nextItemFocus(n,a,e)}),s("a-form-item",e,[s("div",r,[t])])}):[]}function renderActionButtons(e,t){var n=t.$listeners,i=t.submitButtonProps,o=t.cancelButtonProps,r=t.foldingButtonProps,s=t.loading,a=t.onSubmit,l=t.resetFields,u=t.titleWidth,d=t.layout,p=t.expand,c=t.onExpandClick,f=t.items,m=t.currentColspan;if(n&&n.submit&&!1!==i){var h=i&&i.content?i.content:_conf.default.submitButtonProps.content,v=o&&o.content?o.content:_conf.default.cancelButtonProps.content,R=e("a-button",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.submitButtonProps),i),{},{loading:s}),on:{click:a}},[h]),_="";!1!==o&&(_=e("a-button",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.cancelButtonProps),o),on:{click:function(){l()}}},[v]));var b="";if(-1<f.findIndex(function(e){return e.folding})&&!1!==r){var g=r&&r.openText?r.openText:_conf.default.foldingButtonProps.openText,O=r&&r.hideText?r.hideText:_conf.default.foldingButtonProps.hideText,y=r&&r.openIcon?r.openIcon:_conf.default.foldingButtonProps.openIcon,F=r&&r.hideIcon?r.hideIcon:_conf.default.foldingButtonProps.hideIcon,S=p?O:g,x=p?F:y;b=e("a-button",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.foldingButtonProps),r),on:{click:c}},[S,e("a-icon",{props:{type:x}})])}var j=0,I={};return"inline"!=d&&(j=_utils.default.isNumber(u)?"".concat(u,"px"):u),"grid"===d&&m&&1<m?I.gridColumn="span "+m:"flex"===d&&(I.width="100%"),e("div",{class:"data-form-buttons",style:(0,_objectSpread2.default)((0,_objectSpread2.default)({},I),{},{marginLeft:j})},[R,_,b])}}var responsiveMap={xs:"(max-width: 575px)",sm:"(min-width: 576px)",md:"(min-width: 768px)",lg:"(min-width: 992px)",xl:"(min-width: 1200px)",xxl:"(min-width: 1600px)"},_default2={name:"DataForm",components:(0,_objectSpread2.default)({},_index.default),props:{items:{type:Array,default:function(){return[]}},layout:{type:String,default:_conf.default.layout},colspan:{type:[Number,Object],default:_conf.default.colspan},readonly:{type:Boolean,default:!1},titleAlign:{type:String,default:_conf.default.titleAlign},titleWidth:{type:[String,Number],default:_conf.default.titleWidth},titleColon:{type:Boolean,default:_conf.default.titleColon},onOptionsAllLoad:{type:Function,default:function(){}},onOptionsLoadBefore:{type:Function,default:function(){}},filterNullValues:{type:[Boolean,String],default:""},getSelectOptions:Object,submitButtonProps:{type:[Boolean,Object],default:function(){}},cancelButtonProps:{type:[Boolean,Object],default:function(){}},foldingButtonProps:{type:[Boolean,Object],default:function(){}},loading:{type:Boolean,default:!1},autoFocus:{type:[Boolean,String],default:!1},autoLoadOptionsData:{type:[Boolean,String],default:""},isPartRequest:{type:[Boolean,String],default:""}},data:function(){return{form:this.$form.createForm(this),itemsOptions:[],expand:!1,currentColspan:1,focusItemTypes:["a-input","a-password","a-input-number","a-select","a-date-picker","a-time-picker","a-month-picker","a-week-picker","a-range-picker","a-cascader","a-tree-select","a-textarea","a-range-picker-split","a-input-number-split"],unifyApiGetOptions:[],getItemPropsOptionsApiList:[],config:_conf.default}},computed:{enterToNextItemFocusList:function(){var t=this;return this.items.map(function(e){return e.itemRender&&t.focusItemTypes.includes(e.itemRender.name)&&(!e.itemRender.props||1!=e.itemRender.props.disabled&&1!=e.itemRender.props.readonly||!e.itemRender.props)?e.field:e.itemRender&&e.itemRender.name?"":e.field}).filter(function(e){return""!==e})}},watch:{items:function(e){this.cloneItems(e)},colspan:function(e){this.currentColspan=e}},created:function(){this.currentColspan=this.colspan,this.cloneItems(this.items)},mounted:function(){var e=this,o=this;_utils.default.isObject(this.colspan)&&this.$nextTick(function(){var i=Object.keys(responsiveMap);i.map(function(n){return _enquire.default.register(responsiveMap[n],{match:function(){o.currentColspan=o.colspan[n]},unmatch:function(){var e=i.findIndex(function(e){return e===n});if(0<e){var t=e-1;o.currentColspan=o.colspan[i[t]]}},destroy:function(){}})})}),this.autoFocus&&this.enterToNextItemFocusList.length&&this.$nextTick(function(){setTimeout(function(){"string"==typeof e.autoFocus?e.setFieldFocus(e.autoFocus):e.setFieldFocus(e.enterToNextItemFocusList[0])},400)})},beforeDestroy:function(){Object.keys(responsiveMap).map(function(e){return _enquire.default.unregister(responsiveMap[e])})},methods:{cloneItems:function(e){var n=this,t=this.expand,i=this.autoLoadOptionsData,o=this.isPartRequest,r=_utils.default.clone(e,!0),s=[],a=[],l=[];l=t?r:r.filter(function(e){return!e.folding});var u=""!==o?o:_conf.default.getSelectOptions.isPartRequest,d=l.map(function(t){var e=n.itemsOptions.find(function(e){return e.field===t.field});return e&&e.itemRender&&e.itemRender.props&&t.itemRender&&t.itemRender.props&&e.itemRender.props.api===t.itemRender.props.api&&_utils.default.isEqual(e.itemRender.props.param,t.itemRender.props.param)||(t.itemRender&&t.itemRender.props&&(t.itemRender.props.api||t.itemRender.props.param&&!0===u)?(t.itemRender.props.api||(t.itemRender.props.api=_conf.default.getSelectOptions.api),s.push({field:t.field,api:t.itemRender.props.api,param:t.itemRender.props.param,props:t.itemRender.props})):t.itemRender&&t.itemRender.props&&t.itemRender.props.param&&!t.itemRender.props.api&&!0!==u&&a.push(t)),t});this.unifyApiGetOptions=a,this.getItemPropsOptionsApiList=s,(!0!==i&&!1!==i||i===_conf.default.getSelectOptions.autoLoadOptionsData?_conf.default.getSelectOptions.autoLoadOptionsData:i)&&this.loadOptionsData(),this.itemsOptions=d},loadOptionsData:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length?arguments[1]:void 0,n=this.unifyApiGetOptions,i=this.getItemPropsOptionsApiList;n.length?handeUnifyApiGetOptions(n,i,this,e,t):i.length&&fetchItemPropsOptionsApiList(i,this,e,t)},getData:function(){return this.form.getFieldsValue()},setData:function(e){var t=this.items.map(function(e){return e.field}),n={};for(var i in e)t.includes(i)&&(n[i]=e[i]);this.form.setFieldsValue(n)},validateFields:function(e){var s=this,a=this.filterNullValues;return new Promise(function(o,r){s.form.validateFields(e,function(e,t){if(e)r();else{var n=(0,_objectSpread2.default)({},t);if(!a&&!1!==a&&_conf.default.filterNullValues)for(var i in n)n[i]||0==n[i]||delete n[i];n=s.formatSubmitValues(n),o(n)}})})},formatSubmitValues:function(n){return this.items.forEach(function(i){if(i.itemRender&&"upload"===i.itemRender.name&&n[i.field]){var e=n[i.field];if(e.fileList&&e.fileList.length){var t=e.fileList.map(function(e){if(e.url)return e.url;if(e.response){var t=i.itemRender.props&&i.itemRender.props.responseUrlField?i.itemRender.props.responseUrlField:"data",n=_utils.default.getObjData(t,e.response);return n||e}return"done"!==e.status?"":e}).filter(function(e){return""!==e});n[i.field]=t&&t.length?t:void 0}else e.fileList&&0===e.fileList.length&&(n[i.field]=void 0)}}),n},onSubmit:function(e){var i=this;e&&e.preventDefault(),this.form.validateFields(function(e,t){if(!e){var n=(0,_objectSpread2.default)({},t);n=i.formatSubmitValues(n),i.$emit("submit",n)}})},resetFields:function(e){this.form.resetFields(e),this.$emit("reset",e)},setFieldFocus:function(e){var t="input_".concat(e),n=this.$refs[t];n&&n.focus&&n.focus()},setFieldsOptions:function(d){var p=this,c=this.getData(),e=function(t){var e=d[t],n=p.itemsOptions.find(function(e){return e.field===t});if(n&&n.itemRender&&n.itemRender.props){var i=n.itemRender.props,o="input_"+n.field,r=p.$refs[o];if(r&&r.setOptionsData&&r.setOptionsData(e),c[t]){var s=null!=i.valueField?i.valueField:_conf.default.getSelectOptions.valueField;if(_utils.default.isArray(c[t])){for(var a=[],l=0;l<e.length;l++){var u=e[l];c[t].includes(u[s])&&a.push(u[s])}c[t]=a}else{e.find(function(e){return e[s]==c[t]})||(c[t]="")}}}};for(var t in d)e(t);this.setData(c)},setFieldsOptionsDefaultValues:function(){var a=this,l=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},u={};this.itemsOptions.forEach(function(e){if(e&&e.itemRender&&e.itemRender.props&&(l.length&&l.includes(e.field)||0===l.length)){var t=e.itemRender.props.defaultField?e.itemRender.props.defaultField:_conf.default.getSelectOptions.defaultField,n=e.itemRender.props.valueField?e.itemRender.props.valueField:_conf.default.getSelectOptions.valueField,i="input_"+e.field,o=a.$refs[i];if(o&&o.getOptionsData){var r=o.getOptionsData().map(function(e){return e[t]?e[n]:""}).filter(function(e){return""!==e});if(r.length){var s=r;["a-checkbox-group","a-radio-group","a-select"].includes(e.itemRender.name)||1!==r.length||(s=r[0]),u[e.field]=s}}}});var t=(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),u);this.setData(t)},onButtonClick:function(e,t){var n=this.onSubmit,i=this.resetFields;switch(e){case"submit":n();break;case"reset":i()}this.$emit("buttonActionClick",e,t)},getFieldError:function(e){return this.form.getFieldError(e)},getFieldsError:function(e){return this.form.getFieldsError(e)},getFieldValue:function(e){return this.form.getFieldValue(e)},isFieldsTouched:function(e){return this.form.isFieldsTouched(e)},isFieldTouched:function(e){return this.form.isFieldTouched(e)},isFieldValidating:function(e){return this.form.isFieldValidating(e)},setFields:function(e){return this.form.setFields(e)},setExpand:function(e){this.expand=e,this.cloneItems(this.items)},onExpandClick:function(){var e=!this.expand;this.setExpand(e)},loadItemOptionsData:function(n,e){var i=this,t=this.itemsOptions.find(function(e){return e.field===n});if(t&&t.itemRender&&t.itemRender.props&&(t.itemRender.props.api||t.itemRender.props.param)){(t.itemRender.props.api?t.itemRender.props.api:_conf.default.getSelectOptions.api)((0,_objectSpread2.default)((0,_objectSpread2.default)({},t.itemRender.props.param),e)).then(function(e){var t=handlefieldOptionsDataField(n,e,i);i.setFieldsOptions((0,_defineProperty2.default)({},n,t))})}}},render:function(e){var t=this.form,n=this.layout,i=this.currentColspan,o=this.readonly,r=this.onSubmit,s={props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.props),{},{form:t,layout:["horizontal","vertical","inline"].includes(n)?n:null}),class:["data-form",n],style:{},on:{submit:r}};if(o&&s.class.push("readonly"),"grid"===n){for(var a="",l=0;l<i;l++)a+=" 1fr";s.style["grid-template-columns"]=a}return e("a-form",s,[renderItems(e,this),renderActionButtons(e,this)])}};exports.default=_default2;