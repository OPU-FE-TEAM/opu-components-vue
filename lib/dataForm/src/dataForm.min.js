"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.map"),require("core-js/modules/es.function.name"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.for-each"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2"));require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/asyncToGenerator")),_utils=_interopRequireDefault(require("../../utils")),_index=_interopRequireDefault(require("./index")),_conf=_interopRequireDefault(require("../conf"));function nextItemFocus(e,t){var i=t.enterToNextItemFocusList,r=t.setFieldFocus,n=i.indexOf(e.field);-1<n&&n<i.length-1&&r(i[n+1])}function handleItemPropsOptions(e){var t=e.options,i=e.valueField,r=e.labelField;return i||r?_utils.default.clone(t).map(function(e){return i&&(e.value=e[i]),r&&(e.label=e[r]),e}):t}var fetchItemPropsOptionsApiList=function(){var i=(0,_asyncToGenerator2.default)(regeneratorRuntime.mark(function e(t,i){var r,n,o,l,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=i.setFieldsOptions,n=i.onOptionsAllLoad,!(o=i.onOptionsLoadBefore)){e.next=8;break}if(!1===(l=o(t)))return e.abrupt("return",!1);e.next=7;break;case 7:l&&(t=l);case 8:s=t.map(function(e){return(0,e.api)(e.param)}),Promise.all(s).then(function(p){var c={};if(t.forEach(function(e,t){var i=e.field,r=e.valueField,n=e.labelField,o=e.fields,l=e.dataField,s=_utils.default.getObjData(l,p[t]);if(o&&o.length)o.forEach(function(e){var t=_utils.default.getObjData(e.dataField,s);_utils.default.isArray(t)&&(c[e.field]=handleItemPropsOptions({options:t,valueField:e.valueField,labelField:e.labelField}))});else{var a,d;a=r||_conf.default.getSelectOptions.valueField,d=n||_conf.default.getSelectOptions.labelField;var u=handleItemPropsOptions({options:s,valueField:a,labelField:d});c[i]=u}}),n){var e=n(c);e&&(c=e)}r(c)}).catch(function(){});case 10:case"end":return e.stop()}},e)}));return function(e,t){return i.apply(this,arguments)}}();function handeUnifyApiGetOptions(e,t,i){var r=i.getSelectOptions,u={},p=[];e.map(function(e){var t,i,r=e.itemRender.props,n=r.param,o=r.valueField,l=r.labelField,s=r.dataField,a=s||_conf.default.getSelectOptions.dataField;for(var d in t=o||_conf.default.getSelectOptions.valueField,i=l||_conf.default.getSelectOptions.labelField,p.push({field:e.field,valueField:t,labelField:i,dataField:a,param:n}),n)u[d]&&_utils.default.isArray(u[d])?u[d].push(n[d]):u[d]&&!_utils.default.isArray(u[d])?u[d]=[u[d],n[d]]:u[d]=n[d]});var n=r&&r.api?r.api:_conf.default.getSelectOptions.api;n&&t.push({api:n,param:u,fields:p}),fetchItemPropsOptionsApiList(t,i)}function renderItemTitle(e,t,i){var r=i.titleColon,n=i.titleWidth,o=i.titleAlign,l=!1;if(e.option&&e.option.rules&&e.option.rules.length)for(var s=0;s<e.option.rules.length;s++){if(e.option.rules[s].required){l=!0;break}}var a="";a="function"==typeof e.title?[e.title()]:e.title;var d=e.titleWidth||0===e.titleWidth?e.titleWidth:n;return _utils.default.isNumber(d)&&(d="".concat(d,"px")),t("div",{class:["data-form-item-title",o,{colon:!1===e.colon?e.colon:r},{required:l}],style:{width:d}},a)}function renderItemInput(t,e,i){var r=i.$slots,n=i.$scopedSlots,o=i.readonly,l=i.onButtonClick,s=i.items,a=[t.field];t.option&&a.push(t.option);var d=(0,_objectSpread2.default)((0,_objectSpread2.default)({props:{fieldName:t.field}},t.itemRender),{},{ref:"input_"+t.field,directives:[{name:"decorator",value:a}]});if(o||t.itemRender&&t.itemRender.props&&t.itemRender.props.readonly)d.class?_utils.default.isArray(d.class)?d.class.push("input_readonly"):_utils.default.isString(d.class)&&(d.class="".concat(d.class," input_readonly")):d.class=["input_readonly"],d.props?(d.props.disabled=!0,d.props.placeholder=null):d.props={disabled:!0,placeholder:""};else{var u=s.find(function(e){return e.field===t.field});u&&u.itemRender&&u.itemRender.props&&u.itemRender.props.disabled?d.props.disabled=u.itemRender.props.disabled:d.props.disabled=!1}var p="";if(t.itemRender&&t.itemRender.slot)r[t.itemRender.slot]?p=r[t.itemRender.slot]:n[t.itemRender.slot]&&(d.scopedSlots={default:n[t.itemRender.slot]},p=e("a-scopedSlots",d));else if(t.itemRender&&t.itemRender.customRender)t.itemRender&&t.itemRender.props?d.props.customRender=t.itemRender.customRender:d.props={customRender:t.itemRender.customRender},p=e("a-customRender",d);else{var c=t.itemRender&&t.itemRender.name&&"hidden"!==t.itemRender.name?"".concat(t.itemRender.name):"a-input";"buttons"===c&&(d.props?d.props.itemClick=l:d.props={itemClick:l},d.props.items=t.itemRender.items),p=e(c,d)}return p}function renderItemContent(e,t,i){return t("div",{style:{width:i.titleWidth},class:"data-form-item-content"},[renderItemInput(e,t,i)])}function renderItems(l,s){var e=s.itemsOptions,a=s.$slots,d=s.layout,u=s.colspan,p=s.$scopedSlots,c=s.focusItemTypes;return e?e.map(function(t){var e={key:t.field,props:t,style:{},scopedSlots:{}},i="";if(t.slot&&a[t.slot])i=a[t.slot];else if(t.slot&&p[t.slot]){var r=[t.field];t.option&&r.push(t.option),i=l("a-scopedSlots",{props:{fieldName:t.field},scopedSlots:{default:p[t.slot]},directives:[{name:"decorator",value:r}]})}else t.itemRender&&"hidden"===t.itemRender.name?(i=[renderItemContent(t,l,s)],e.style.display="none"):(e.scopedSlots.label=function(){return renderItemTitle(t,l,s)},i=[renderItemContent(t,l,s)]);if("grid"===d)t.colspan&&1<t.colspan&&(e.style.gridColumn="span "+t.colspan),t.rowspan&&1<t.rowspan&&(e.style.gridRow="span "+t.rowspan);else if("flex"===d){var n=100/u;t.width?e.style.width=t.width:t.colspan&&1<t.colspan?e.style.width="".concat(n*t.colspan,"%"):e.style.width="".concat(n,"%")}var o={class:["data-form-item-wrapper",t.align],on:{}};return t.itemRender&&c.includes(t.itemRender.name)&&"textarea"!==t.itemRender.name&&(o.on.keydown=function(e){13===e.keyCode&&(e.preventDefault(),nextItemFocus(t,s))}),l("a-form-item",e,[l("div",o,[i])])}):[]}var _default2={name:"DataForm",components:(0,_objectSpread2.default)({},_index.default),props:{items:{type:Array,default:function(){return[]}},layout:{type:String,default:_conf.default.layout},colspan:{type:Number,default:_conf.default.colspan},readonly:{type:Boolean,default:!1},titleAlign:{type:String,default:_conf.default.titleAlign},titleWidth:{type:[String,Number],default:_conf.default.titleWidth},titleColon:{type:Boolean,default:_conf.default.titleColon},onOptionsAllLoad:{type:Function,default:function(){}},onOptionsLoadBefore:{type:Function,default:function(){}},filterNullValues:{type:[Boolean,String],default:""}},data:function(){return{form:this.$form.createForm(this),itemsOptions:[],focusItemTypes:["input","password","number","select","datePicker","monthPicker","weekPicker","rangePicker","cascader","treeSelect","textarea"]}},computed:{enterToNextItemFocusList:function(){var t=this;return this.items.map(function(e){return e.itemRender&&t.focusItemTypes.includes(e.itemRender.name)&&(e.itemRender.props&&!0!==e.itemRender.props.disabled||!e.itemRender.props)?e.field:""}).filter(function(e){return""!==e})}},watch:{items:function(e){this.cloneItems(e)}},created:function(){this.cloneItems(this.items)},methods:{cloneItems:function(e){var t=_utils.default.clone(e,!0),o=[],l=[],i=t.map(function(e){if(e.itemRender&&e.itemRender.props&&e.itemRender.props.options){var t,i;t=e.itemRender.props.valueField?e.itemRender.props.valueField:_conf.default.getSelectOptions.valueField,i=e.itemRender.props.labelField?e.itemRender.props.labelField:_conf.default.getSelectOptions.labelField;var r=(0,_objectSpread2.default)({},e.itemRender.props);["a-cascader"].includes(e.itemRender.name)||(r=(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.itemRender.props),{},{valueField:t,labelField:i}));var n=handleItemPropsOptions(r);e.itemRender.props.options=n}else e.itemRender&&e.itemRender.props&&e.itemRender.props.api?o.push({field:e.field,api:e.itemRender.props.api,valueField:e.itemRender.props.valueField,labelField:e.itemRender.props.labelField,param:e.itemRender.props.param}):e.itemRender&&e.itemRender.props&&e.itemRender.props.param&&!e.itemRender.props.api&&l.push(e);return e});l.length?handeUnifyApiGetOptions(l,o,this):o.length&&fetchItemPropsOptionsApiList(o,this),this.itemsOptions=i},getData:function(){return this.form.getFieldsValue()},setData:function(e){var t=this.items.map(function(e){return e.field}),i={};for(var r in e)t.includes(r)&&(i[r]=e[r]);this.form.setFieldsValue(i)},validateFields:function(e){var l=this,s=this.filterNullValues;return new Promise(function(n,o){l.form.validateFields(e,function(e,t){if(e)o();else{var i=(0,_objectSpread2.default)({},t);if(!s&&!1!==s&&_conf.default.filterNullValues)for(var r in i)i[r]||0==i[r]||delete i[r];i=l.formatSubmitValues(i),n(i)}})})},formatSubmitValues:function(i){return this.items.forEach(function(r){if(r.itemRender&&"upload"===r.itemRender.name&&i[r.field]){var e=i[r.field];if(e.fileList&&e.fileList.length){var t=e.fileList.map(function(e){if(e.url)return e.url;if(e.response){var t=r.itemRender.props&&r.itemRender.props.responseUrlField?r.itemRender.props.responseUrlField:"data",i=_utils.default.getObjData(t,e.response);return i||e}return"done"!==e.status?"":e}).filter(function(e){return""!==e});i[r.field]=t&&t.length?t:void 0}else e.fileList&&0===e.fileList.length&&(i[r.field]=void 0)}}),i},onSubmit:function(e){var r=this;e&&e.preventDefault(),this.form.validateFields(function(e,t){if(!e){var i=(0,_objectSpread2.default)({},t);i=r.formatSubmitValues(i),r.$emit("submit",i)}})},resetFields:function(e){this.form.resetFields(e)},setFieldFocus:function(e){var t="input_".concat(e),i=this.$refs[t];i&&i.focus&&i.focus()},setFieldsOptions:function(r){var n=this,o={},e=function(t){var e=r[t],i=n.itemsOptions.find(function(e){return e.field===t});i&&i.itemRender&&i.itemRender.props&&("a-checkbox-group"===i.itemRender.name?o[t]=[]:o[t]="","a-tree-select"===i.itemRender.props.name?i.itemRender.props.treeData=e:i.itemRender.props.options=e)};for(var t in r)e(t);this.setData(o)},setFieldsOptionsDefaultValues:function(){var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},l={};this.itemsOptions.forEach(function(e){if(e&&e.itemRender&&e.itemRender.props&&e.itemRender.props.options&&(o.length&&o.includes(e.field)||0===o.length)){var t=e.itemRender.props.defaultField?e.itemRender.props.defaultField:"default",i=e.itemRender.props.valueField?e.itemRender.props.valueField:"id",r=e.itemRender.props.options.map(function(e){return e[t]?e[i]:""}).filter(function(e){return""!==e});if(r.length){var n=r;["a-checkbox-group","a-radio-group","a-select"].includes(e.itemRender.name)||1!==r.length||(n=r[0]),l[e.field]=n}}});var t=(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),l);this.setData(t)},onButtonClick:function(e){var t=this.onSubmit,i=this.resetFields;switch(e){case"submit":t();break;case"reset":i()}this.$emit("buttonActionClick",e)},getFieldError:function(e){return this.form.getFieldError(e)},getFieldsError:function(e){return this.form.getFieldsError(e)},getFieldValue:function(e){return this.form.getFieldValue(e)},isFieldsTouched:function(e){return this.form.isFieldsTouched(e)},isFieldTouched:function(e){return this.form.isFieldTouched(e)},isFieldValidating:function(e){return this.form.isFieldValidating(e)},setFields:function(e){return this.form.setFields(e)}},render:function(e){var t=this.form,i=this.$slots,r=this.layout,n=this.colspan,o=this.readonly,l=this.onSubmit,s={props:{form:t,layout:["horizontal","vertical","inline"].includes(r)?r:null},class:["data-form",r],style:{},on:{submit:l}};if(o&&s.class.push("readonly"),"grid"===r){for(var a="",d=0;d<n;d++)a+=" 1fr";s.style["grid-template-columns"]=a}return e("a-form",s,[].concat(i.default||renderItems(e,this)))}};exports.default=_default2;