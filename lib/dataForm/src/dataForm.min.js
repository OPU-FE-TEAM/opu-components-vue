"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.map"),require("core-js/modules/es.function.name"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.for-each"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2"));require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/asyncToGenerator")),_utils=_interopRequireDefault(require("../../utils")),_index=_interopRequireDefault(require("./index")),_conf=_interopRequireDefault(require("../conf")),baseComponents=["a-date-picker"],optionsComponents=["a-select","a-radio-group","a-checkbox-group","a-cascader","a-tree-select"];function nextItemFocus(e,t){var r=t.enterToNextItemFocusList,i=t.setFieldFocus,n=r.indexOf(e.field);-1<n&&n<r.length-1&&i(r[n+1])}function handeUnifyApiGetOptions(e,t,r){var i=r.getSelectOptions,n={},o=[];e.map(function(e){var t=e.itemRender.props.param;for(var r in o.push({field:e.field,param:t}),t)n[r]&&_utils.default.isArray(n[r])?n[r].push(t[r]):n[r]&&!_utils.default.isArray(n[r])?n[r]=[n[r],t[r]]:n[r]=t[r]});var s=i&&i.api?i.api:_conf.default.getSelectOptions.api;s&&t.push({api:s,param:n,fields:o}),fetchItemPropsOptionsApiList(t,r)}var fetchItemPropsOptionsApiList=function(){var r=(0,_asyncToGenerator2.default)(regeneratorRuntime.mark(function e(t,l){var r,i,n,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.setFieldsOptions,i=l.onOptionsAllLoad,!(n=l.onOptionsLoadBefore)){e.next=8;break}if(!1===(o=n(t)))return e.abrupt("return",!1);e.next=7;break;case 7:o&&(t=o);case 8:s=t.map(function(e){return(0,e.api)(e.param)}),Promise.all(s).then(function(s){var a={};if(t.forEach(function(e,t){var r=e.field,i=e.fields,n=s[t];if(i&&i.length)i.forEach(function(e){var t=handlefieldOptionsDataField(e.field,n,l);a[e.field]=t});else{var o=handlefieldOptionsDataField(r,n,l);a[r]=o}}),i){var e=i(a);e&&(a=e)}r(a)}).catch(function(){});case 10:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}();function handlefieldOptionsDataField(t,e,r){var i=r.itemsOptions.find(function(e){return e.field===t}),n=e;if(i&&i.itemRender&&i.itemRender.props){var o=i.itemRender.props,s=null!=o.dataField?o.dataField:_conf.default.getSelectOptions.dataField;n=_utils.default.getObjData(s,e)}return n}function renderItemTitle(e,t,r){var i=r.titleColon,n=r.titleWidth,o=r.titleAlign,s=!1;if(e.option&&e.option.rules&&e.option.rules.length)for(var a=0;a<e.option.rules.length;a++){if(e.option.rules[a].required){s=!0;break}}var l="";l="function"==typeof e.title?[e.title()]:e.title;var d=e.titleWidth||0===e.titleWidth?e.titleWidth:n;return _utils.default.isNumber(d)&&(d="".concat(d,"px")),t("div",{class:["data-form-item-title",o,{colon:!1===e.colon?e.colon:i},{required:s}],style:{width:d}},l)}function renderItemInput(t,e,r){var i=r.$slots,n=r.$scopedSlots,o=r.readonly,s=r.onButtonClick,a=r.items,l=[t.field];t.option&&l.push(t.option);var d=(0,_objectSpread2.default)((0,_objectSpread2.default)({props:{fieldName:t.field}},t.itemRender),{},{ref:"input_"+t.field,directives:[{name:"decorator",value:l}]});if(o||t.itemRender&&t.itemRender.props&&t.itemRender.props.readonly)d.class?_utils.default.isArray(d.class)?d.class.push("input_readonly"):_utils.default.isString(d.class)&&(d.class="".concat(d.class," input_readonly")):d.class=["input_readonly"],d.props?(d.props.disabled=!0,d.props.placeholder=null):d.props={disabled:!0,placeholder:""};else{var u=a.find(function(e){return e.field===t.field});u&&u.itemRender&&u.itemRender.props&&u.itemRender.props.disabled?d.props.disabled=u.itemRender.props.disabled:d.props.disabled=!1}var p="";if(t.itemRender&&t.itemRender.slot)i[t.itemRender.slot]?p=i[t.itemRender.slot]:n[t.itemRender.slot]&&(d.scopedSlots={default:n[t.itemRender.slot]},p=e("a-scopedSlots",d));else if(t.itemRender&&t.itemRender.customRender)t.itemRender&&t.itemRender.props?d.props.customRender=t.itemRender.customRender:d.props={customRender:t.itemRender.customRender},p=e("a-customRender",d);else{var c=t.itemRender&&t.itemRender.name&&"hidden"!==t.itemRender.name?"".concat(t.itemRender.name):"a-input";"buttons"===c?(d.props?d.props.itemClick=s:d.props={itemClick:s},d.props.items=t.itemRender.items):optionsComponents.includes(c)?(d.props.componentPropsData=d.props,d.props.renderName=c,c="options-component"):baseComponents.includes(c)&&(d.props.componentPropsData=d.props,d.props.renderName=c,c="base-component",d.on&&_utils.default.isObject(d.on)?d.on.inputPressEnter=function(){nextItemFocus(t,r)}:d.on={inputPressEnter:function(){nextItemFocus(t,r)}}),p=e(c,d)}return p}function renderItemContent(e,t,r){var i=r.titleWidth,n=e.itemRender.before?e.itemRender.before():"",o=e.itemRender.after?e.itemRender.after():"";return t("div",{style:{width:i},class:"data-form-item-content"},[t("div",{class:"data-form-item-before"},[n]),t("div",{class:"data-form-item-input"},[renderItemInput(e,t,r)]),t("div",{class:"data-form-item-after"},[o])])}function renderItems(s,a){var e=a.itemsOptions,l=a.$slots,d=a.layout,u=a.colspan,p=a.$scopedSlots,c=a.focusItemTypes;return e?e.map(function(r){var e={key:r.field,props:r,style:{},scopedSlots:{}},t="";if(r.slot&&l[r.slot])t=l[r.slot];else if(r.slot&&p[r.slot]){var i=[r.field];r.option&&i.push(r.option),t=s("a-scopedSlots",{props:{fieldName:r.field},scopedSlots:{default:p[r.slot]},directives:[{name:"decorator",value:i}]})}else r.itemRender&&"hidden"===r.itemRender.name?(t=[renderItemContent(r,s,a)],e.style.display="none"):(e.scopedSlots.label=function(){return renderItemTitle(r,s,a)},t=[renderItemContent(r,s,a)]);if("grid"===d)r.colspan&&1<r.colspan&&(e.style.gridColumn="span "+r.colspan),r.rowspan&&1<r.rowspan&&(e.style.gridRow="span "+r.rowspan);else if("flex"===d){var n=100/u;r.width?e.style.width=r.width:r.colspan&&1<r.colspan?e.style.width="".concat(n*r.colspan,"%"):e.style.width="".concat(n,"%")}var o={class:["data-form-item-wrapper",r.align],on:{}};return r.itemRender&&c.includes(r.itemRender.name)&&"textarea"!==r.itemRender.name&&(o.on.keyup=function(e){var t=e.keyCode;e.stopPropagation(),13===t&&nextItemFocus(r,a)}),s("a-form-item",e,[s("div",o,[t])])}):[]}function renderActionButtons(e,t){var r=t.$listeners,i=t.submitButtonProps,n=t.cancelButtonProps,o=t.loading,s=t.onSubmit,a=t.resetFields,l=t.titleWidth,d=t.layout;if(r&&r.submit&&!1!==i){var u=i&&i.content?i.content:_conf.default.submitButtonProps.content,p=n&&n.content?n.content:_conf.default.cancelButtonProps.content,c=e("a-button",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.submitButtonProps),i),{},{loading:o}),on:{click:s}},[u]),f="";!1!==n&&(f=e("a-button",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.cancelButtonProps),n),on:{click:a}},[p]));var m=0;return"inline"!=d&&(m=_utils.default.isNumber(l)?"".concat(l,"px"):l),e("div",{class:"data-form-buttons",style:{marginLeft:m}},[c,f])}}var _default2={name:"DataForm",components:(0,_objectSpread2.default)({},_index.default),props:{items:{type:Array,default:function(){return[]}},layout:{type:String,default:_conf.default.layout},colspan:{type:Number,default:_conf.default.colspan},readonly:{type:Boolean,default:!1},titleAlign:{type:String,default:_conf.default.titleAlign},titleWidth:{type:[String,Number],default:_conf.default.titleWidth},titleColon:{type:Boolean,default:_conf.default.titleColon},onOptionsAllLoad:{type:Function,default:function(){}},onOptionsLoadBefore:{type:Function,default:function(){}},filterNullValues:{type:[Boolean,String],default:""},getSelectOptions:Object,submitButtonProps:{type:[Boolean,Object],default:function(){}},cancelButtonProps:{type:[Boolean,Object],default:function(){}},loading:{type:Boolean,default:!1}},data:function(){return{form:this.$form.createForm(this),itemsOptions:[],focusItemTypes:["a-input","a-password","a-input-number","a-select","a-date-picker","a-month-picker","a-week-picker","a-range-picker","a-cascader","a-tree-select","a-textarea"]}},computed:{enterToNextItemFocusList:function(){var t=this;return this.items.map(function(e){return e.itemRender&&t.focusItemTypes.includes(e.itemRender.name)&&(e.itemRender.props&&!0!==e.itemRender.props.disabled||!e.itemRender.props)?e.field:""}).filter(function(e){return""!==e})}},watch:{items:function(e){this.cloneItems(e)}},created:function(){this.cloneItems(this.items)},methods:{cloneItems:function(e){var r=this,t=_utils.default.clone(e,!0),i=[],n=[],o=t.map(function(t){var e=r.itemsOptions.find(function(e){return e.field===t.field});return e&&e.itemRender&&e.itemRender.props&&t.itemRender&&t.itemRender.props&&e.itemRender.props.api===t.itemRender.props.api&&_utils.default.isEqual(e.itemRender.props.param,t.itemRender.props.param)||(t.itemRender&&t.itemRender.props&&t.itemRender.props.api?i.push({field:t.field,api:t.itemRender.props.api,param:t.itemRender.props.param}):t.itemRender&&t.itemRender.props&&t.itemRender.props.param&&!t.itemRender.props.api&&n.push(t)),t});n.length?handeUnifyApiGetOptions(n,i,this):i.length&&fetchItemPropsOptionsApiList(i,this),this.itemsOptions=o},getData:function(){return this.form.getFieldsValue()},setData:function(e){var t=this.items.map(function(e){return e.field}),r={};for(var i in e)t.includes(i)&&(r[i]=e[i]);this.form.setFieldsValue(r)},validateFields:function(e){var s=this,a=this.filterNullValues;return new Promise(function(n,o){s.form.validateFields(e,function(e,t){if(e)o();else{var r=(0,_objectSpread2.default)({},t);if(!a&&!1!==a&&_conf.default.filterNullValues)for(var i in r)r[i]||0==r[i]||delete r[i];r=s.formatSubmitValues(r),n(r)}})})},formatSubmitValues:function(r){return this.items.forEach(function(i){if(i.itemRender&&"upload"===i.itemRender.name&&r[i.field]){var e=r[i.field];if(e.fileList&&e.fileList.length){var t=e.fileList.map(function(e){if(e.url)return e.url;if(e.response){var t=i.itemRender.props&&i.itemRender.props.responseUrlField?i.itemRender.props.responseUrlField:"data",r=_utils.default.getObjData(t,e.response);return r||e}return"done"!==e.status?"":e}).filter(function(e){return""!==e});r[i.field]=t&&t.length?t:void 0}else e.fileList&&0===e.fileList.length&&(r[i.field]=void 0)}}),r},onSubmit:function(e){var i=this;e&&e.preventDefault(),this.form.validateFields(function(e,t){if(!e){var r=(0,_objectSpread2.default)({},t);r=i.formatSubmitValues(r),i.$emit("submit",r)}})},resetFields:function(e){this.form.resetFields(e)},setFieldFocus:function(e){var t="input_".concat(e),r=this.$refs[t];r&&r.focus&&r.focus()},setFieldsOptions:function(u){var p=this,c=this.getData(),e=function(t){var e=u[t],r=p.itemsOptions.find(function(e){return e.field===t});if(r&&r.itemRender&&r.itemRender.props){var i=r.itemRender.props,n="input_"+r.field,o=p.$refs[n];if(o&&o.setOptionsData&&o.setOptionsData(e),c[t]){var s=null!=i.valueField?i.valueField:_conf.default.getSelectOptions.valueField;if(_utils.default.isArray(c[t])){for(var a=[],l=0;l<e.length;l++){var d=e[l];c[t].includes(d[s])&&a.push(d[s])}c[t]=a}else{e.find(function(e){return e[s]==c[t]})||(c[t]="")}}}};for(var t in u)e(t);this.setData(c)},setFieldsOptionsDefaultValues:function(){var a=this,l=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d={};this.itemsOptions.forEach(function(e){if(e&&e.itemRender&&e.itemRender.props&&(l.length&&l.includes(e.field)||0===l.length)){var t=e.itemRender.props.defaultField?e.itemRender.props.defaultField:_conf.default.getSelectOptions.defaultField,r=e.itemRender.props.valueField?e.itemRender.props.valueField:_conf.default.getSelectOptions.valueField,i="input_"+e.field,n=a.$refs[i];if(n&&n.getOptionsData){var o=n.getOptionsData().map(function(e){return e[t]?e[r]:""}).filter(function(e){return""!==e});if(o.length){var s=o;["a-checkbox-group","a-radio-group","a-select"].includes(e.itemRender.name)||1!==o.length||(s=o[0]),d[e.field]=s}}}});var t=(0,_objectSpread2.default)((0,_objectSpread2.default)({},e),d);this.setData(t)},onButtonClick:function(e){var t=this.onSubmit,r=this.resetFields;switch(e){case"submit":t();break;case"reset":r()}this.$emit("buttonActionClick",e)},getFieldError:function(e){return this.form.getFieldError(e)},getFieldsError:function(e){return this.form.getFieldsError(e)},getFieldValue:function(e){return this.form.getFieldValue(e)},isFieldsTouched:function(e){return this.form.isFieldsTouched(e)},isFieldTouched:function(e){return this.form.isFieldTouched(e)},isFieldValidating:function(e){return this.form.isFieldValidating(e)},setFields:function(e){return this.form.setFields(e)}},render:function(e){var t=this.form,r=this.layout,i=this.colspan,n=this.readonly,o=this.onSubmit,s={props:{form:t,layout:["horizontal","vertical","inline"].includes(r)?r:null},class:["data-form",r],style:{},on:{submit:o}};if(n&&s.class.push("readonly"),"grid"===r){for(var a="",l=0;l<i;l++)a+=" 1fr";s.style["grid-template-columns"]=a}return e("a-form",s,[renderItems(e,this),renderActionButtons(e,this)])}};exports.default=_default2;