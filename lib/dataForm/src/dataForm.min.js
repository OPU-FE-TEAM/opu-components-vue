"use strict";var _interopRequireDefault=require("D:/demo/vue-npm-template/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.index-of"),require("core-js/modules/es.array.map"),require("core-js/modules/es.function.name"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.for-each"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("D:/demo/vue-npm-template/node_modules/@babel/runtime/helpers/esm/defineProperty")),_objectSpread3=_interopRequireDefault(require("D:/demo/vue-npm-template/node_modules/@babel/runtime/helpers/esm/objectSpread2"));require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("D:/demo/vue-npm-template/node_modules/@babel/runtime/helpers/esm/asyncToGenerator")),_utils=_interopRequireDefault(require("../../utils")),_form=_interopRequireDefault(require("ant-design-vue/es/form"));require("ant-design-vue/lib/form/style/css");var _objectSpread2,_index=_interopRequireDefault(require("./index")),_conf=_interopRequireDefault(require("../conf"));function nextItemFocus(e,t){var r=t.enterToNextItemFocusList,i=t.setFieldFocus,n=r.indexOf(e.field);-1<n&&n<r.length-1&&i(r[n+1])}function handleItemPropsOptions(e){var t=e.options,r=e.valueField,i=e.labelField;return r||i?_utils.default.clone(t).map(function(e){return r&&(e.value=e[r]),i&&(e.label=e[i]),e}):t}var fetchItemPropsOptionsApiList=function(){var r=(0,_asyncToGenerator2.default)(regeneratorRuntime.mark(function e(t,r){var i,n,o,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.setFieldsOptions,n=r.onOptionsAllLoad,!(o=r.onOptionsLoadBefore)){e.next=8;break}if(!1===(s=o(t)))return e.abrupt("return",!1);e.next=7;break;case 7:s&&(t=s);case 8:a=t.map(function(e){return(0,e.api)(e.param)}),Promise.all(a).then(function(l){var d={};if(t.forEach(function(e,t){var r=e.field,i=e.valueField,n=e.labelField,o=e.fields,s=l[t];if(o&&o.length)o.forEach(function(e){for(var t in e.param)e.param[t]&&s[e.param[t]]&&(d[e.field]=handleItemPropsOptions({options:s[e.param[t]],valueField:e.valueField,labelField:e.labelField}))});else{var a=handleItemPropsOptions({options:l[t],valueField:i,labelField:n});d[r]=a}}),n){var e=n(d);e&&(d=e)}i(d)}).catch(function(){});case 10:case"end":return e.stop()}},e)}));return function(e,t){return r.apply(this,arguments)}}();function handeUnifyApiGetOptions(e,t,r){var i=r.fieldsOptionsApi,s={},a=[];e.map(function(e){var t=e.itemRender.props,r=t.param,i=t.valueField,n=t.labelField;for(var o in a.push({field:e.field,valueField:i,labelField:n,param:r}),r)s[o]&&_utils.default.isArray(s[o])?s[o].push(r[o]):s[o]&&!_utils.default.isArray(s[o])?s[o]=[s[o],r[o]]:s[o]=r[o]}),(i||_conf.default.fieldsOptionsApi)&&t.push({api:i||_conf.default.fieldsOptionsApi,param:s,fields:a}),fetchItemPropsOptionsApiList(t,r)}function renderItemTitle(e,t,r){var i=r.titleColon,n=r.titleWidth,o=!1;if(e.option&&e.option.rules&&e.option.rules.length)for(var s=0;s<e.option.rules.length;s++){if(e.option.rules[s].required){o=!0;break}}var a="";a="function"==typeof e.title?[e.title()]:e.title;var l=e.titleWidth||0===e.titleWidth?e.titleWidth:n;return _utils.default.isNumber(l)&&(l="".concat(l,"px")),t("div",{class:["data-form-item-title",{colon:!1===e.colon?e.colon:i},{required:o}],style:{width:l}},a)}function renderItemInput(e,t,r){var i=r.$slots,n=r.$scopedSlots,o=r.readonly,s=r.onButtonClick,a=[e.field];e.option&&a.push(e.option);var l=(0,_objectSpread3.default)((0,_objectSpread3.default)({props:{}},e.itemRender),{},{ref:"input_"+e.field,directives:[{name:"decorator",value:a}]});o&&(l.props?(l.props.disabled=!0,l.props.placeholder=null):l.props={disabled:!0,placeholder:""});var d="";if(e.itemRender&&e.itemRender.slot)i[e.itemRender.slot]?d=i[e.itemRender.slot]:n[e.itemRender.slot]&&(l.scopedSlots={default:n[e.itemRender.slot]},d=t("a-scopedSlots",l));else if(e.itemRender&&e.itemRender.customRender)e.itemRender&&e.itemRender.props?l.props.customRender=e.itemRender.customRender:l.props={customRender:e.itemRender.customRender},d=t("a-customRender",l);else{var u=e.itemRender&&e.itemRender.name?"a-".concat(e.itemRender.name):"a-input";"a-buttons"===u&&(l.props?l.props.itemClick=s:l.props={itemClick:s}),d=t(u,l)}return d}function renderItemContent(e,t,r){return t("div",{style:{width:r.titleWidth},class:"data-form-item-content"},[renderItemInput(e,t,r)])}function renderItems(s,a){var e=a.itemsOptions,l=a.$slots,d=a.layout,u=a.colspan,p=a.$scopedSlots,m=a.focusItemTypes;return e?e.map(function(t){var e={key:t.field,props:t,style:{},scopedSlots:{}},r="";if(t.slot&&l[t.slot])r=l[t.slot];else if(t.slot&&p[t.slot]){var i=[t.field];t.option&&i.push(t.option),r=s("a-scopedSlots",{scopedSlots:{default:p[t.slot]},directives:[{name:"decorator",value:i}]})}else"hidden"===t.type?(r=[renderItemContent(t,s,a)],e.style.display="none"):(e.scopedSlots.label=function(){return renderItemTitle(t,s,a)},r=[renderItemContent(t,s,a)]);if("grid"===d)t.colspan&&1<t.colspan&&(e.style.gridColumn="span "+t.colspan),t.rowspan&&1<t.rowspan&&(e.style.gridRow="span "+t.rowspan);else if("flex"===d){var n=100/u;t.width?e.style.width=t.width:t.colspan&&1<t.colspan?e.style.width="".concat(n*t.colspan,"%"):e.style.width="".concat(n,"%")}var o={class:["data-form-item-wrapper",t.align],on:{}};return t.itemRender&&m.includes(t.itemRender.name)&&"textarea"!==t.itemRender.name&&(o.on.keydown=function(e){13===e.keyCode&&(e.preventDefault(),nextItemFocus(t,a))}),s("a-form-item",e,[s("div",o,[r])])}):[]}var _default2={name:"DataForm",components:(0,_objectSpread3.default)((0,_objectSpread3.default)({},_index.default),{},(_objectSpread2={},(0,_defineProperty2.default)(_objectSpread2,_form.default.name,_form.default),(0,_defineProperty2.default)(_objectSpread2,_form.default.Item.name,_form.default.Item),_objectSpread2)),props:{items:{type:Array,default:function(){return[]}},layout:{type:String,default:"grid"},colspan:{type:Number,default:1},readonly:{type:Boolean,default:!1},size:{type:String,default:"small"},titleAlign:{type:String,default:"right"},titleWidth:{type:[String,Number],default:100},titleColon:{type:Boolean,default:!0},titleAsterisk:{type:Boolean,default:!0},loading:{type:Boolean,default:!1},onOptionsAllLoad:{type:Function,default:function(){}},onOptionsLoadBefore:{type:Function,default:function(){}},onButtonActionClick:{type:Function,default:function(){}}},data:function(){return{form:this.$form.createForm(this),itemsOptions:[],focusItemTypes:["input","password","number","select","datePicker","monthPicker","weekPicker","rangePicker","cascader","treeSelect","textarea"]}},computed:{enterToNextItemFocusList:function(){var t=this;return this.items.map(function(e){return e.itemRender&&t.focusItemTypes.includes(e.itemRender.name)&&(e.itemRender.props&&!0!==e.itemRender.props.disabled||!e.itemRender.props)?e.field:""}).filter(function(e){return""!==e})}},watch:{items:function(e){this.cloneItems(e)}},created:function(){this.cloneItems(this.items)},methods:{cloneItems:function(e){var t=_utils.default.clone(e),r=[],i=[],n=t.map(function(e){if(e.itemRender&&e.itemRender.props&&e.itemRender.props.options){var t=handleItemPropsOptions(e.itemRender.props);e.itemRender.props.options=t}else e.itemRender&&e.itemRender.props&&e.itemRender.props.api?r.push({field:e.field,api:e.itemRender.props.api,valueField:e.itemRender.props.valueField,labelField:e.itemRender.props.labelField,param:e.itemRender.props.param}):e.itemRender&&e.itemRender.props&&e.itemRender.props.param&&!e.itemRender.props.api&&i.push(e);return e});i.length?handeUnifyApiGetOptions(i,r,this):r.length&&fetchItemPropsOptionsApiList(r,this),this.itemsOptions=n},getData:function(){return this.form.getFieldsValue()},setData:function(e){var t=this.items.map(function(e){return e.field}),r={};for(var i in e)t.includes(i)&&(r[i]=e[i]);this.form.setFieldsValue(r)},validateFields:function(e){var o=this;return new Promise(function(i,n){o.form.validateFields(e,function(e,t){if(e)n();else{var r=(0,_objectSpread3.default)({},t);r=o.formatSubmitValues(r),i(r)}})})},formatSubmitValues:function(r){return this.items.forEach(function(i){if(i.itemRender&&"upload"===i.itemRender.name&&r[i.field]){var e=r[i.field];if(e.fileList&&e.fileList.length){var t=e.fileList.map(function(e){if(e.url)return e.url;if(e.response){var t=i.itemRender.props&&i.itemRender.props.responseUrlField?i.itemRender.props.responseUrlField:"data",r=_utils.default.getObjData(t,e.response);return r||e}return"done"!==e.status?"":e}).filter(function(e){return""!==e});r[i.field]=t&&t.length?t:void 0}else e.fileList&&0===e.fileList.length&&(r[i.field]=void 0)}}),r},onSubmit:function(e){var i=this;e&&e.preventDefault(),this.form.validateFields(function(e,t){if(!e){var r=(0,_objectSpread3.default)({},t);r=i.formatSubmitValues(r),i.$emit("submit",r)}})},onReset:function(){},setFieldFocus:function(e){var t="input_".concat(e),r=this.$refs[t];r&&r.focus&&r.focus()},setFieldsOptions:function(i){var n=this,o={},e=function(t){var e=i[t],r=n.itemsOptions.find(function(e){return e.field===t});r&&r.itemRender&&r.itemRender.props&&("checkboxGroup"===r.itemRender.name?o[t]=[]:o[t]="","treeSelect"===r.itemRender.props.name?r.itemRender.props.treeData=e:r.itemRender.props.options=e)};for(var t in i)e(t);this.setData(o)},setFieldsOptionsDefaultValues:function(){var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s={};this.itemsOptions.forEach(function(e){if(e&&e.itemRender&&e.itemRender.props&&e.itemRender.props.options&&(o.length&&o.includes(e.field)||0===o.length)){var t=e.itemRender.props.defaultField?e.itemRender.props.defaultField:"default",r=e.itemRender.props.valueField?e.itemRender.props.valueField:"id",i=e.itemRender.props.options.map(function(e){return e[t]?e[r]:""}).filter(function(e){return""!==e});if(i.length){var n=i;["checkboxGroup","radioGroup"].includes(e.itemRender.name)||1!==i.length||(n=i[0]),s[e.field]=n}}});var t=(0,_objectSpread3.default)((0,_objectSpread3.default)({},e),s);this.setData(t)},onButtonClick:function(e){var t=this.onSubmit,r=this.onReset,i=this.onButtonActionClick;switch(e){case"submit":t();break;case"reset":r();break;default:i&&i(e)}}},render:function(e){var t=this.form,r=this.$slots,i=this.layout,n=this.colspan,o=this.readonly,s=this.onSubmit,a={props:{form:t,layout:["horizontal","vertical","inline"].includes(i)?i:null},class:["data-form",i],style:{},on:{submit:s}};if(o&&a.class.push("readonly"),"grid"===i){for(var l="",d=0;d<n;d++)l+=" 1fr";a.style["grid-template-columns"]=l}return e("a-form",a,[].concat(r.default||renderItems(e,this)))}};exports.default=_default2;