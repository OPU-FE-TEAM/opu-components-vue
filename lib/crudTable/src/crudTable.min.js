"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.map"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.string.includes"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue")),_dataForm=require("../../dataForm"),_dataTable=require("../../dataTable"),_formModal=_interopRequireDefault(require("./formModal")),_conf=_interopRequireDefault(require("../conf")),_utils=_interopRequireDefault(require("../../utils"));function renderFormModal(e,t,o,i){return o("FormModal",{ref:"formModal",props:{modal:e,form:t},on:{submit:i.onFormModalSubmit,cancel:i.onFormModalCancel},scopedSlots:i.$scopedSlots})}var _default2={name:"CrudTable",components:{DataForm:_dataForm.DataForm,DataTable:_dataTable.DataTable,FormModal:_formModal.default},props:{form:Object,modal:{type:Object,default:function(){}},table:Object,proxyConfig:Object,permissions:[Boolean,Array]},computed:{proxyConfigOpt:function(){var e={};if(this.proxyConfig&&this.proxyConfig.add){var t=this.proxyConfig.add&&this.proxyConfig.add.props?this.proxyConfig.add.props:{};e.add=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add),this.proxyConfig.add),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add.props),t)})}else e.add=_conf.default.proxyConfig.add;if(this.proxyConfig&&this.proxyConfig.edit){var o=this.proxyConfig.edit&&this.proxyConfig.edit.props?this.proxyConfig.edit.props:{};e.edit=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit),this.proxyConfig.edit),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit.props),o)})}else e.edit=_conf.default.proxyConfig.edit;if(this.proxyConfig&&this.proxyConfig.del){var i=this.proxyConfig.del&&this.proxyConfig.del.props?this.proxyConfig.del.props:{};e.del=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del),this.proxyConfig.del),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del.props),i)})}else e.del=_conf.default.proxyConfig.del;if(this.proxyConfig&&this.proxyConfig.view){var r=this.proxyConfig.view&&this.proxyConfig.view.props?this.proxyConfig.view.props:{};e.view=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view),this.proxyConfig.view),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view.props),r)})}else e.view=_conf.default.proxyConfig.view;return e},tableProps:function(){var e=this.table,t=this.tableData,o=this.onToobarButtonClick,i=this.$scopedSlots,r=this.proxyConfig,a=this.proxyConfigOpt,s=this.renderRowAction,n=this.permissions,d=this.view,l=n||_conf.default.permissions,u={props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.table),e.props),{},{data:t,columns:e.props.columns}),on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.on),{},{toobarButtonClick:o})};if(r.view&&a.view.trigger&&(a.view.trigger.includes("click")&&(u.on["cell-click"]=function(e){var t=e.row;d(t)}),a.view.trigger.includes("dblclick")&&(u.on["cell-dblclick"]=function(e){var t=e.row;d(t)})),!(u.props.headToolbar&&u.props.headToolbar.buttons&&r.add)){var f=a.add.props;r.add&&r.add.permission&&!_utils.default.hasEquaValueArray(l,r.add.permission)&&(f.disabled=!0),u.props.headToolbar.buttons=[(0,_objectSpread2.default)({name:"新增",code:"add",type:"primary"},f)]}return r&&(r.edit||r.del)&&!i.rowAction&&(i.rowAction=s),u.scopedSlots=i,u.ref="table",u}},data:function(){return{tableData:[],currentAction:""}},methods:{onToobarButtonClick:function(e){var t=this.add;switch(e){case"add":t()}},onFormModalSubmit:function(e){var r=this,a=this.proxyConfig,s=this.currentAction;if(a&&a[s]&&a[s].submit){var n=this.$refs.formModal;a[s].submit(e).then(function(e){n.onCancel();var t=a[s].responseMsgField?a[s].responseMsgField:_conf.default.proxyConfig[s].responseMsgField,o=t?_utils.default.getObjData(t,e):"",i=o||"操作成功";r.$message.success(i),r.reloadTable()}).catch(function(){n.setConfirmLoading(!1)})}},onFormModalCancel:function(){},reloadTable:function(e){this.$refs.table.reload(e)},renderRowAction:function(e){var t=this.proxyConfig,o=this.edit,i=this.del,r=this.view,a=this.permissions,s=this.proxyConfigOpt,n=this.$scopedSlots,d=(new _vue.default).$createElement,l=a||_conf.default.permissions,u=[];if(t&&t.view&&s.view.trigger.includes("button")){var f=s.view.props;if(_utils.default.isArray(t.view.permission)&&!_utils.default.hasEquaValueArray(l,t.view.permission))f.disabled=!0;else if(_utils.default.isFunction(t.view.permission)){var p=t.view.permission(e);f.disabled=!p}u.push(d("a-button",{props:f,on:{click:function(){r(e.row)}}},f.name?f.name:"查看"))}if(t&&t.edit){var c=s.edit.props;if(_utils.default.isArray(t.edit.permission)&&!_utils.default.hasEquaValueArray(l,t.edit.permission))c.disabled=!0;else if(_utils.default.isFunction(t.edit.permission)){var m=t.edit.permission(e);c.disabled=!m}u.push(d("a-button",{props:c,on:{click:function(){o(e.row)}}},c.name?c.name:"编辑"))}if(t&&t.del){var h=s.del.props;if(_utils.default.isArray(t.del.permission)&&!_utils.default.hasEquaValueArray(l,t.del.permission))h.disabled=!0;else if(_utils.default.isFunction(t.del.permission)){var b=t.del.permission(e);h.disabled=!b}h.disabled?u.push(d("a-button",{props:h},h.name?h.name:"删除")):u.push(d("a-popconfirm",{props:{title:s.del.popconfirmTitle},on:{confirm:function(){i(e.row)}}},[d("a-button",{props:h},h.name?h.name:"删除")]))}var v="";n.rowActionBefore&&(v=n.rowActionBefore(e));var _="";return n.rowActionAfter&&(_=n.rowActionAfter(e)),d("div",{class:"crud-table-row-actions"},[v,u,_])},add:function(){var e=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,i=t.add.props,r="";if(e&&e.add&&e.add.open){var a=e.add.open();if(!1===a)return!1;a&&_utils.default.isFunction(a)&&(r=a)}this.currentAction="add";var s=this.$refs.formModal;if(!s)return!1;s.setReadonly(!1),s.setTitle(e.add.modalTitle?e.add.modalTitle:i.name),s.setItems(o(this.currentAction)),s.show(r),s.setLoading(!1)},edit:function(e){var i=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,r=t.edit.props,a="";if(i&&i.edit&&i.edit.open){var s=i.edit.open(e);if(!1===s)return!1;s&&_utils.default.isFunction(s)&&(a=s)}this.currentAction="edit";var n=this.$refs.formModal;if(!n)return!1;n.setTitle(i.edit.modalTitle?i.edit.modalTitle:r.name),n.setItems(o(this.currentAction)),n.setReadonly(!1),n.show(a),i&&i.edit&&i.edit.query?i.edit.query(e).then(function(e){var t=e,o=null!=i.edit.queryDataField?i.edit.queryDataField:_conf.default.proxyConfig.edit.queryDataField;o&&(t=_utils.default.getObjData(o,e)),n.setFormData(t)}):setTimeout(function(){n.setFormData(e)},100)},del:function(e){this.currentAction="del",this.onFormModalSubmit(e)},view:function(e){var i=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,r=t.view.props,a="";if(i&&i.view&&i.view.open){var s=i.view.open(e);if(!1===s)return!1;s&&_utils.default.isFunction(s)&&(a=s)}this.currentAction="view";var n=this.$refs.formModal;if(!n)return!1;n.setReadonly(!0),n.setTitle(i.view.modalTitle?i.view.modalTitle:r.name),n.setItems(o(this.currentAction)),n.show(a),i&&i.view&&i.view.query?i.view.query(e).then(function(e){var t=e,o=null!=i.view.queryDataField?i.view.queryDataField:_conf.default.proxyConfig.view.queryDataField;o&&(t=_utils.default.getObjData(o,e)),n.setFormData(t)}):n.setFormData(e)},filterFormItems:function(t){return this.form.props.items.filter(function(e){return!(e.filter&&!e.filter.includes(t))})},getTableData:function(){return this.$refs.table.getData()},getRefs:function(){return this.$refs}},render:function(t){var e=this.tableProps,o=this.modal,i=this.form,r=this.$slots,a="";o&&i&&(a=renderFormModal(o,i,t,this));var s=Object.keys(r).map(function(e){return t("template",{slot:e},[r[e]])});return t("div",{class:"crud-table"},[a,[t("data-table",(0,_objectSpread2.default)({},e),s)]])}};exports.default=_default2;