"use strict";var _interopRequireDefault=require("E:/T/git/奥普Team/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.map"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.string.includes"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("E:/T/git/奥普Team/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue")),_dataForm=require("../../dataForm"),_dataTable=require("../../dataTable"),_formModal=_interopRequireDefault(require("./formModal")),_conf=_interopRequireDefault(require("../conf")),_utils=_interopRequireDefault(require("../../utils"));function renderFormModal(e,t,o,i){var r=i.onFormModalSubmit,a=i.onFormModalCancel,s=i.$scopedSlots;return o("FormModal",{ref:"formModal",props:{modal:e,form:t,onOptionsLoadAfter:i.onOptionsLoadAfter},on:{submit:r,cancel:a},scopedSlots:s})}var _default2={name:"CrudTable",components:{DataForm:_dataForm.DataForm,DataTable:_dataTable.DataTable,FormModal:_formModal.default},props:{form:Object,modal:{type:Object,default:function(){}},table:Object,proxyConfig:Object,permissions:[Boolean,Array]},computed:{proxyConfigOpt:function(){var e={};if(this.proxyConfig&&this.proxyConfig.add){var t=this.proxyConfig.add&&this.proxyConfig.add.props?this.proxyConfig.add.props:{};e.add=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add),this.proxyConfig.add),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add.props),t)})}else e.add=_conf.default.proxyConfig.add;if(this.proxyConfig&&this.proxyConfig.edit){var o=this.proxyConfig.edit&&this.proxyConfig.edit.props?this.proxyConfig.edit.props:{};e.edit=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit),this.proxyConfig.edit),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit.props),o)})}else e.edit=_conf.default.proxyConfig.edit;if(this.proxyConfig&&this.proxyConfig.del){var i=this.proxyConfig.del&&this.proxyConfig.del.props?this.proxyConfig.del.props:{};e.del=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del),this.proxyConfig.del),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del.props),i)})}else e.del=_conf.default.proxyConfig.del;if(this.proxyConfig&&this.proxyConfig.view){var r=this.proxyConfig.view&&this.proxyConfig.view.props?this.proxyConfig.view.props:{};e.view=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view),this.proxyConfig.view),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view.props),r)})}else e.view=_conf.default.proxyConfig.view;return e},tableProps:function(){var e=this.table,t=this.tableData,o=this.onToobarButtonClick,i=this.$scopedSlots,r=this.proxyConfig,a=this.proxyConfigOpt,s=this.renderRowAction,n=this.permissions,d=this.view,l=n||_conf.default.permissions,u={props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.table),e.props),{},{data:t,columns:e.props.columns}),on:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.on),{},{toobarButtonClick:o})};if(r.view&&a.view.trigger&&(a.view.trigger.includes("click")&&(u.on["cell-click"]=function(e){var t=e.row;d(t)}),a.view.trigger.includes("dblclick")&&(u.on["cell-dblclick"]=function(e){var t=e.row;d(t)})),(!u.props.headToolbar||!u.props.headToolbar.buttons)&&r.add){var f=a.add.props;r.add&&r.add.permission&&!_utils.default.hasEquaValueArray(l,r.add.permission)&&(f.disabled=!0),u.props.headToolbar.buttons=[(0,_objectSpread2.default)({name:"新增",code:"add",type:"primary"},f)]}return r&&(r.edit||r.del)&&!i.rowAction&&(i.rowAction=s),u.scopedSlots=i,u.ref="table",u}},data:function(){return{tableData:[],currentAction:""}},methods:{onToobarButtonClick:function(e){var t=this.add;switch(e){case"add":t()}},onFormModalSubmit:function(e){var i=this,r=this.proxyConfig,a=this.currentAction;if(r&&r[a]&&r[a].submit){var s=this.$refs.formModal;r[a].submit(e).then(function(e){s&&s.onCancel();var t=r[a].successMsgCode?r[a].successMsgCode:_conf.default.proxyConfig[a].successMsgCode,o=r[a].responseCodeField?r[a].responseCodeField:_conf.default.proxyConfig[a].responseCodeField;(t||0==t)&&o?(o?_utils.default.getObjData(o,e):"")===t&&i.formModalSubmitMessage(e):i.formModalSubmitMessage(e);i.reloadTable()}).catch(function(){s&&s.setConfirmLoading(!1)})}},formModalSubmitMessage:function(e){var t=this.proxyConfig,o=this.currentAction,i=t[o].responseMsgField?t[o].responseMsgField:_conf.default.proxyConfig[o].responseMsgField,r=i?_utils.default.getObjData(i,e):"",a=r||"操作成功";this.$message.success(a)},onFormModalCancel:function(){this.modal.on&&this.modal.on.cancel&&this.modal.on.cancel()},reloadTable:function(e){this.$refs.table.reload(e)},renderRowAction:function(t){var e=this.proxyConfig,o=this.edit,i=this.del,r=this.view,a=this.permissions,s=this.proxyConfigOpt,n=this.$scopedSlots,d=(new _vue.default).$createElement,l=a||_conf.default.permissions,u=[];if(e&&e.view&&s.view.trigger.includes("button")){var f=s.view.props;if(_utils.default.isArray(e.view.permission)&&!_utils.default.hasEquaValueArray(l,e.view.permission))f.disabled=!0;else if(_utils.default.isFunction(e.view.permission)){var p=e.view.permission(t);f.disabled=!p}u.push(d("a-button",{props:f,on:{click:function(){r(t.row)}}},f.name?f.name:"查看"))}if(e&&e.edit){var c=s.edit.props;if(_utils.default.isArray(e.edit.permission)&&!_utils.default.hasEquaValueArray(l,e.edit.permission))c.disabled=!0;else if(_utils.default.isFunction(e.edit.permission)){var m=e.edit.permission(t);c.disabled=!m}u.push(d("a-button",{props:c,on:{click:function(e){o(t.row,e)}}},c.name?c.name:"编辑"))}if(e&&e.del){var h=s.del.props;if(_utils.default.isArray(e.del.permission)&&!_utils.default.hasEquaValueArray(l,e.del.permission))h.disabled=!0;else if(_utils.default.isFunction(e.del.permission)){var b=e.del.permission(t);h.disabled=!b}h.disabled?u.push(d("a-button",{props:h},h.name?h.name:"删除")):u.push(d("a-popconfirm",{props:{title:s.del.popconfirmTitle},on:{confirm:function(){i(t.row)}}},[d("a-button",{props:h},h.name?h.name:"删除")]))}var g="";n.rowActionBefore&&(g=n.rowActionBefore(t));var _="";return n.rowActionAfter&&(_=n.rowActionAfter(t)),d("div",{class:"crud-table-row-actions"},[g,u,_])},add:function(e){e&&e.target.blur();var t=this.proxyConfig,o=this.proxyConfigOpt,i=this.filterFormItems,r=o.add.props,a="";if(t&&t.add&&t.add.open){var s=t.add.open();if(!1===s)return!1;s&&_utils.default.isFunction(s)&&(a=s)}this.currentAction="add";var n=this.$refs.formModal;if(!n)return!1;n.setReadonly(!1),n.setTitle(t.add.modalTitle?t.add.modalTitle:r.name),n.setItems(i(this.currentAction)),n.show(a,this.currentAction),n.loadOptionsData(),n.setLoading(!1)},edit:function(e,t){t&&t.target.blur();var i=this.proxyConfig,o=this.proxyConfigOpt,r=this.filterFormItems,a=o.edit.props,s="";if(i&&i.edit&&i.edit.open){var n=i.edit.open(e);if(!1===n)return!1;n&&_utils.default.isFunction(n)&&(s=n)}this.currentAction="edit";var d=this.$refs.formModal;if(!d)return!1;d.setTitle(i.edit.modalTitle?i.edit.modalTitle:a.name),d.setItems(r(this.currentAction)),d.setReadonly(!1),d.show(s,this.currentAction),i&&i.edit&&i.edit.query?i.edit.query(e).then(function(e){var t=e,o=null!=i.edit.queryDataField?i.edit.queryDataField:_conf.default.proxyConfig.edit.queryDataField;o&&(t=_utils.default.getObjData(o,e)),d.setFormData(t)}):setTimeout(function(){d.setFormData(e)},100)},del:function(e){this.currentAction="del",this.onFormModalSubmit(e)},view:function(e){var i=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,r=t.view.props,a="";if(i&&i.view&&i.view.open){var s=i.view.open(e);if(!1===s)return!1;s&&_utils.default.isFunction(s)&&(a=s)}this.currentAction="view";var n=this.$refs.formModal;if(!n)return!1;n.setReadonly(!0),n.setTitle(i.view.modalTitle?i.view.modalTitle:r.name),n.setItems(o(this.currentAction)),n.show(a,this.currentAction),i&&i.view&&i.view.query?i.view.query(e).then(function(e){var t=e,o=null!=i.view.queryDataField?i.view.queryDataField:_conf.default.proxyConfig.view.queryDataField;o&&(t=_utils.default.getObjData(o,e)),n.setFormData(t)}):n.setFormData(e)},onOptionsLoadAfter:function(){this.proxyConfig[this.currentAction].autoSetDefaultValue&&this.$refs.formModal.$refs.form.setFieldsOptionsDefaultValues()},filterFormItems:function(t){return this.form.props.items.filter(function(e){return!(e.filter&&!e.filter.includes(t))})},getTableData:function(){return this.$refs.table.getData()},getRefs:function(){return this.$refs}},render:function(t){var e=this.tableProps,o=this.modal,i=this.form,r=this.$slots,a="";o&&i&&(a=renderFormModal(o,i,t,this));var s=Object.keys(r).map(function(e){return t("template",{slot:e},[r[e]])});return t("div",{class:"crud-table"},[a,[t("data-table",(0,_objectSpread2.default)({},e),s)]])}};exports.default=_default2;