"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.includes"),require("core-js/modules/es.function.name"),require("core-js/modules/es.string.includes"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue")),_dataForm=require("../../dataForm"),_dataTable=require("../../dataTable"),_formModal=_interopRequireDefault(require("./formModal")),_conf=_interopRequireDefault(require("../conf")),_utils=_interopRequireDefault(require("../../utils"));function renderFormModal(e,o,t,i){return t("FormModal",{ref:"formModal",props:{modal:e,form:o},on:{submit:i.onFormModalSubmit,cancel:i.onFormModalCancel},scopedSlots:i.$scopedSlots})}var _default2={name:"CrudTable",components:{DataForm:_dataForm.DataForm,DataTable:_dataTable.DataTable,FormModal:_formModal.default},props:{form:Object,modal:{type:Object,default:function(){}},table:Object,proxyConfig:Object,permissions:Array},computed:{proxyConfigOpt:function(){var e={};if(this.proxyConfig&&this.proxyConfig.add){var o=this.proxyConfig.add&&this.proxyConfig.add.props?this.proxyConfig.add.props:{};e.add=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add),this.proxyConfig.add),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add.props),o)})}else e.add=_conf.default.proxyConfig.add;if(this.proxyConfig&&this.proxyConfig.edit){var t=this.proxyConfig.edit&&this.proxyConfig.edit.props?this.proxyConfig.edit.props:{};e.edit=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit),this.proxyConfig.edit),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit.props),t)})}else e.edit=_conf.default.proxyConfig.edit;if(this.proxyConfig&&this.proxyConfig.del){var i=this.proxyConfig.del&&this.proxyConfig.del.props?this.proxyConfig.del.props:{};e.del=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del),this.proxyConfig.del),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del.props),i)})}else e.del=_conf.default.proxyConfig.del;if(this.proxyConfig&&this.proxyConfig.view){var r=this.proxyConfig.view&&this.proxyConfig.view.props?this.proxyConfig.view.props:{};e.view=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view),this.proxyConfig.view),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view.props),r)})}else e.view=_conf.default.proxyConfig.view;return e},tableProps:function(){var e=this.table,o=this.tableData,t=this.onToobarButtonClick,i=this.$scopedSlots,r=this.proxyConfig,a=this.proxyConfigOpt,d=this.renderRowAction,n=this.permissions,s=this.view,l=n||_conf.default.permissions,p={props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},e.props),{},{data:o,columns:e.props.columns}),on:{toobarButtonClick:t}};if(r.view&&a.view.trigger&&(a.view.trigger.includes("click")&&(p.on["cell-click"]=function(e){var o=e.row;s(o)}),a.view.trigger.includes("dblclick")&&(p.on["cell-dblclick"]=function(e){var o=e.row;s(o)})),!(p.props.headToolbar&&p.props.headToolbar.buttons&&r.add)){var u=a.add.props;r.add.permission&&!_utils.default.hasEquaValueArray(l,r.add.permission)&&(u.disabled=!0),p.props.headToolbar.buttons=[(0,_objectSpread2.default)({name:"新增",code:"add",type:"primary"},u)]}return r&&(r.edit||r.del)&&!i.rowAction&&(i.rowAction=d),p.scopedSlots=i,p.ref="table",p}},data:function(){return{tableData:[],currentAction:""}},methods:{onToobarButtonClick:function(e){var o=this.add;switch(e){case"add":o()}},onFormModalSubmit:function(e){var o=this;console.log(e);var t=this.proxyConfig,i=this.currentAction;t&&t[i]&&t[i].submit&&t[i].submit(e).then(function(e){console.log(e),o.reloadTable()})},onFormModalCancel:function(){console.log(2)},reloadTable:function(){this.$refs.table.reload()},renderRowAction:function(e){var o=this.proxyConfig,t=this.edit,i=this.del,r=this.view,a=this.permissions,d=this.proxyConfigOpt,n=(new _vue.default).$createElement,s=a||_conf.default.permissions,l=[];if(o&&o.view&&d.view.trigger.includes("button")){var p=d.view.props;o.view.permission&&!_utils.default.hasEquaValueArray(s,o.view.permission)&&(p.disabled=!0),l.push(n("a-button",{props:p,on:{click:function(){r(e.row)}}},p.name?p.name:"查看"))}if(o&&o.edit){var u=d.edit.props;o.edit.permission&&!_utils.default.hasEquaValueArray(s,o.edit.permission)&&(u.disabled=!0),l.push(n("a-button",{props:u,on:{click:function(){t(e.row)}}},u.name?u.name:"编辑"))}if(o&&o.del){var f=d.del.props;o.del.permission&&!_utils.default.hasEquaValueArray(s,o.del.permission)&&(f.disabled=!0),l.push(n("a-popconfirm",{props:{title:d.del.popconfirmTitle},on:{confirm:function(){i(e.row)}}},[n("a-button",{props:f},f.name?f.name:"删除")]))}return n("div",{class:"crud-table-row-actions"},l)},add:function(){var e=this.proxyConfig,o=this.proxyConfigOpt.add.props,t="";if(e&&e.add&&e.add.open){var i=e.add.open();if(!1===i)return!1;i&&_utils.default.isFunction(i)&&(t=i)}var r=this.$refs.formModal;r.setReadonly(!1),r.setTitle(e.add.modalTitle?e.add.modalTitle:o.name),r.show(t),r.setLoading(!1),this.currentAction="add"},edit:function(e){var o=this.proxyConfig,t=this.proxyConfigOpt.edit.props,i="";if(o&&o.edit&&o.edit.open){var r=o.edit.open();if(!1===r)return!1;r&&_utils.default.isFunction(r)&&(i=r)}var a=this.$refs.formModal;a.setTitle(o.edit.modalTitle?o.edit.modalTitle:t.name),a.setReadonly(!1),a.show(i),o&&o.edit&&o.edit.query?o.edit.query(e).then(function(e){a.setFormData(e)}):a.setFormData(e),this.currentAction="edit"},del:function(e){this.currentAction="del",this.onFormModalSubmit(e)},view:function(e){var o=this.proxyConfig,t=this.proxyConfigOpt.view.props,i="";if(o&&o.view&&o.view.open){var r=o.view.open();if(!1===r)return!1;r&&_utils.default.isFunction(r)&&(i=r)}var a=this.$refs.formModal;a.setReadonly(!0),a.setTitle(o.view.modalTitle?o.view.modalTitle:t.name),a.show(i),o&&o.view&&o.view.query?o.view.query(e).then(function(e){a.setFormData(e)}):a.setFormData(e),this.currentAction="view"}},render:function(e){var o=this.tableProps;return e("div",{class:"crud-table"},[renderFormModal(this.modal,this.form,e,this),e("data-table",o,"")])}};exports.default=_default2;