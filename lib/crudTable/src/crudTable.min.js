"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.function.name"),require("core-js/modules/es.string.includes"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue")),_dataForm=require("../../dataForm"),_dataTable=require("../../dataTable"),_formModal=_interopRequireDefault(require("./formModal")),_conf=_interopRequireDefault(require("../conf")),_utils=_interopRequireDefault(require("../../utils"));function renderFormModal(e,o,t,r){return t("FormModal",{ref:"formModal",props:{modal:e,form:o},on:{submit:r.onFormModalSubmit,cancel:r.onFormModalCancel},scopedSlots:r.$scopedSlots})}var _default2={name:"CrudTable",components:{DataForm:_dataForm.DataForm,DataTable:_dataTable.DataTable,FormModal:_formModal.default},props:{form:Object,modal:{type:Object,default:function(){}},table:Object,proxyConfig:Object,permissions:Array},computed:{proxyConfigOpt:function(){var e={};if(this.proxyConfig&&this.proxyConfig.add){var o=this.proxyConfig.add&&this.proxyConfig.add.props?this.proxyConfig.add.props:{};e.add=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add),this.proxyConfig.add),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add.props),o)})}else e.add=_conf.default.proxyConfig.add;if(this.proxyConfig&&this.proxyConfig.edit){var t=this.proxyConfig.edit&&this.proxyConfig.edit.props?this.proxyConfig.edit.props:{};e.edit=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit),this.proxyConfig.edit),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit.props),t)})}else e.edit=_conf.default.proxyConfig.edit;if(this.proxyConfig&&this.proxyConfig.del){var r=this.proxyConfig.del&&this.proxyConfig.del.props?this.proxyConfig.del.props:{};e.del=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del),this.proxyConfig.del),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del.props),r)})}else e.del=_conf.default.proxyConfig.del;if(this.proxyConfig&&this.proxyConfig.view){var i=this.proxyConfig.view&&this.proxyConfig.view.props?this.proxyConfig.view.props:{};e.view=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view),this.proxyConfig.view),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view.props),i)})}else e.view=_conf.default.proxyConfig.view;return e},tableProps:function(){var e=this.table,o=this.tableData,t=this.onToobarButtonClick,r=this.$scopedSlots,i=this.proxyConfig,a=this.proxyConfigOpt,n=this.renderRowAction,d=this.permissions,s=this.view,l=d||_conf.default.permissions,p={props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.table),e.props),{},{data:o,columns:e.props.columns}),on:{toobarButtonClick:t}};if(i.view&&a.view.trigger&&(a.view.trigger.includes("click")&&(p.on["cell-click"]=function(e){var o=e.row;s(o)}),a.view.trigger.includes("dblclick")&&(p.on["cell-dblclick"]=function(e){var o=e.row;s(o)})),!(p.props.headToolbar&&p.props.headToolbar.buttons&&i.add)){var f=a.add.props;i.add.permission&&!_utils.default.hasEquaValueArray(l,i.add.permission)&&(f.disabled=!0),p.props.headToolbar.buttons=[(0,_objectSpread2.default)({name:"新增",code:"add",type:"primary"},f)]}return i&&(i.edit||i.del)&&!r.rowAction&&(r.rowAction=n),p.scopedSlots=r,p.ref="table",p}},data:function(){return{tableData:[],currentAction:""}},methods:{onToobarButtonClick:function(e){var o=this.add;switch(e){case"add":o()}},onFormModalSubmit:function(e){var o=this;console.log(e);var t=this.proxyConfig,r=this.currentAction;t&&t[r]&&t[r].submit&&t[r].submit(e).then(function(e){console.log(e),o.reloadTable()})},onFormModalCancel:function(){console.log(2)},reloadTable:function(){this.$refs.table.reload()},renderRowAction:function(e){var o=this.proxyConfig,t=this.edit,r=this.del,i=this.view,a=this.permissions,n=this.proxyConfigOpt,d=this.$scopedSlots,s=(new _vue.default).$createElement,l=a||_conf.default.permissions,p=[];if(o&&o.view&&n.view.trigger.includes("button")){var f=n.view.props;o.view.permission&&!_utils.default.hasEquaValueArray(l,o.view.permission)&&(f.disabled=!0),p.push(s("a-button",{props:f,on:{click:function(){i(e.row)}}},f.name?f.name:"查看"))}if(o&&o.edit){var u=n.edit.props;o.edit.permission&&!_utils.default.hasEquaValueArray(l,o.edit.permission)&&(u.disabled=!0),p.push(s("a-button",{props:u,on:{click:function(){t(e.row)}}},u.name?u.name:"编辑"))}if(o&&o.del){var c=n.del.props;o.del.permission&&!_utils.default.hasEquaValueArray(l,o.del.permission)&&(c.disabled=!0),p.push(s("a-popconfirm",{props:{title:n.del.popconfirmTitle},on:{confirm:function(){r(e.row)}}},[s("a-button",{props:c},c.name?c.name:"删除")]))}var m="";d.rowActionBefore&&(m=d.rowActionBefore(e));var h="";return d.rowActionAfter&&(h=d.rowActionAfter(e)),s("div",{class:"crud-table-row-actions"},[m,p,h])},add:function(){var e=this.proxyConfig,o=this.proxyConfigOpt,t=this.filterFormItems,r=o.add.props,i="";if(e&&e.add&&e.add.open){var a=e.add.open();if(!1===a)return!1;a&&_utils.default.isFunction(a)&&(i=a)}this.currentAction="add";var n=this.$refs.formModal;n.setReadonly(!1),n.setTitle(e.add.modalTitle?e.add.modalTitle:r.name),n.setItems(t(this.currentAction)),n.show(i),n.setLoading(!1)},edit:function(e){var o=this.proxyConfig,t=this.proxyConfigOpt,r=this.filterFormItems,i=t.edit.props,a="";if(o&&o.edit&&o.edit.open){var n=o.edit.open();if(!1===n)return!1;n&&_utils.default.isFunction(n)&&(a=n)}this.currentAction="edit";var d=this.$refs.formModal;d.setTitle(o.edit.modalTitle?o.edit.modalTitle:i.name),d.setItems(r(this.currentAction)),d.setReadonly(!1),d.show(a),o&&o.edit&&o.edit.query?o.edit.query(e).then(function(e){d.setFormData(e)}):d.setFormData(e)},del:function(e){this.currentAction="del",this.onFormModalSubmit(e)},view:function(e){var o=this.proxyConfig,t=this.proxyConfigOpt,r=this.filterFormItems,i=t.view.props,a="";if(o&&o.view&&o.view.open){var n=o.view.open();if(!1===n)return!1;n&&_utils.default.isFunction(n)&&(a=n)}this.currentAction="view";var d=this.$refs.formModal;d.setReadonly(!0),d.setTitle(o.view.modalTitle?o.view.modalTitle:i.name),d.setItems(r(this.currentAction)),d.show(a),o&&o.view&&o.view.query?o.view.query(e).then(function(e){d.setFormData(e)}):d.setFormData(e)},filterFormItems:function(o){return this.form.props.items.filter(function(e){return!(e.filter&&!e.filter.includes(o))})}},render:function(e){var o=this.tableProps;return e("div",{class:"crud-table"},[renderFormModal(this.modal,this.form,e,this),e("data-table",o,"")])}};exports.default=_default2;