"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.function.name"),require("core-js/modules/es.string.includes"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_vue=_interopRequireDefault(require("vue")),_dataForm=require("../../dataForm"),_dataTable=require("../../dataTable"),_formModal=_interopRequireDefault(require("./formModal")),_conf=_interopRequireDefault(require("../conf")),_utils=_interopRequireDefault(require("../../utils"));function renderFormModal(e,t,o,i){return o("FormModal",{ref:"formModal",props:{modal:e,form:t},on:{submit:i.onFormModalSubmit,cancel:i.onFormModalCancel},scopedSlots:i.$scopedSlots})}var _default2={name:"CrudTable",components:{DataForm:_dataForm.DataForm,DataTable:_dataTable.DataTable,FormModal:_formModal.default},props:{form:Object,modal:{type:Object,default:function(){}},table:Object,proxyConfig:Object,permissions:Array},computed:{proxyConfigOpt:function(){var e={};if(this.proxyConfig&&this.proxyConfig.add){var t=this.proxyConfig.add&&this.proxyConfig.add.props?this.proxyConfig.add.props:{};e.add=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add),this.proxyConfig.add),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.add.props),t)})}else e.add=_conf.default.proxyConfig.add;if(this.proxyConfig&&this.proxyConfig.edit){var o=this.proxyConfig.edit&&this.proxyConfig.edit.props?this.proxyConfig.edit.props:{};e.edit=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit),this.proxyConfig.edit),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.edit.props),o)})}else e.edit=_conf.default.proxyConfig.edit;if(this.proxyConfig&&this.proxyConfig.del){var i=this.proxyConfig.del&&this.proxyConfig.del.props?this.proxyConfig.del.props:{};e.del=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del),this.proxyConfig.del),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.del.props),i)})}else e.del=_conf.default.proxyConfig.del;if(this.proxyConfig&&this.proxyConfig.view){var r=this.proxyConfig.view&&this.proxyConfig.view.props?this.proxyConfig.view.props:{};e.view=(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view),this.proxyConfig.view),{},{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.proxyConfig.view.props),r)})}else e.view=_conf.default.proxyConfig.view;return e},tableProps:function(){var e=this.table,t=this.tableData,o=this.onToobarButtonClick,i=this.$scopedSlots,r=this.proxyConfig,a=this.proxyConfigOpt,d=this.renderRowAction,s=this.permissions,n=this.view,l=s||_conf.default.permissions,u={props:(0,_objectSpread2.default)((0,_objectSpread2.default)((0,_objectSpread2.default)({},_conf.default.table),e.props),{},{data:t,columns:e.props.columns}),on:{toobarButtonClick:o}};if(r.view&&a.view.trigger&&(a.view.trigger.includes("click")&&(u.on["cell-click"]=function(e){var t=e.row;n(t)}),a.view.trigger.includes("dblclick")&&(u.on["cell-dblclick"]=function(e){var t=e.row;n(t)})),!(u.props.headToolbar&&u.props.headToolbar.buttons&&r.add)){var p=a.add.props;r.add.permission&&!_utils.default.hasEquaValueArray(l,r.add.permission)&&(p.disabled=!0),u.props.headToolbar.buttons=[(0,_objectSpread2.default)({name:"新增",code:"add",type:"primary"},p)]}return r&&(r.edit||r.del)&&!i.rowAction&&(i.rowAction=d),u.scopedSlots=i,u.ref="table",u}},data:function(){return{tableData:[],currentAction:""}},methods:{onToobarButtonClick:function(e){var t=this.add;switch(e){case"add":t()}},onFormModalSubmit:function(e){var r=this,a=this.proxyConfig,d=this.currentAction;a&&a[d]&&a[d].submit&&a[d].submit(e).then(function(e){var t=a[d].responseMsgField?a[d].responseMsgField:_conf.default.proxyConfig[d].responseMsgField,o=t?_utils.default.getObjData(t,e):"",i=o||"操作成功";r.$message.success(i),r.reloadTable()})},onFormModalCancel:function(){},reloadTable:function(){this.$refs.table.reload()},renderRowAction:function(e){var t=this.proxyConfig,o=this.edit,i=this.del,r=this.view,a=this.permissions,d=this.proxyConfigOpt,s=this.$scopedSlots,n=(new _vue.default).$createElement,l=a||_conf.default.permissions,u=[];if(t&&t.view&&d.view.trigger.includes("button")){var p=d.view.props;if(_utils.default.isArray(t.view.permission)&&!_utils.default.hasEquaValueArray(l,t.view.permission))p.disabled=!0;else if(_utils.default.isFunction(t.view.permission)){var f=t.view.permission(e);p.disabled=!f}u.push(n("a-button",{props:p,on:{click:function(){r(e.row)}}},p.name?p.name:"查看"))}if(t&&t.edit){var c=d.edit.props;t.edit.permission&&!_utils.default.hasEquaValueArray(l,t.edit.permission)&&(c.disabled=!0),u.push(n("a-button",{props:c,on:{click:function(){o(e.row)}}},c.name?c.name:"编辑"))}if(t&&t.del){var m=d.del.props;t.del.permission&&!_utils.default.hasEquaValueArray(l,t.del.permission)&&(m.disabled=!0),u.push(n("a-popconfirm",{props:{title:d.del.popconfirmTitle},on:{confirm:function(){i(e.row)}}},[n("a-button",{props:m},m.name?m.name:"删除")]))}var h="";s.rowActionBefore&&(h=s.rowActionBefore(e));var b="";return s.rowActionAfter&&(b=s.rowActionAfter(e)),n("div",{class:"crud-table-row-actions"},[h,u,b])},add:function(){var e=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,i=t.add.props,r="";if(e&&e.add&&e.add.open){var a=e.add.open();if(!1===a)return!1;a&&_utils.default.isFunction(a)&&(r=a)}this.currentAction="add";var d=this.$refs.formModal;d.setReadonly(!1),d.setTitle(e.add.modalTitle?e.add.modalTitle:i.name),d.setItems(o(this.currentAction)),d.show(r),d.setLoading(!1)},edit:function(e){var i=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,r=t.edit.props,a="";if(i&&i.edit&&i.edit.open){var d=i.edit.open();if(!1===d)return!1;d&&_utils.default.isFunction(d)&&(a=d)}this.currentAction="edit";var s=this.$refs.formModal;s.setTitle(i.edit.modalTitle?i.edit.modalTitle:r.name),s.setItems(o(this.currentAction)),s.setReadonly(!1),s.show(a),i&&i.edit&&i.edit.query?i.edit.query(e).then(function(e){var t=e,o=null!=i.edit.queryDataField?i.edit.queryDataField:_conf.default.proxyConfig.edit.queryDataField;o&&(t=_utils.default.getObjData(o,e)),s.setFormData(t)}):s.setFormData(e)},del:function(e){this.currentAction="del",this.onFormModalSubmit(e)},view:function(e){var i=this.proxyConfig,t=this.proxyConfigOpt,o=this.filterFormItems,r=t.view.props,a="";if(i&&i.view&&i.view.open){var d=i.view.open();if(!1===d)return!1;d&&_utils.default.isFunction(d)&&(a=d)}this.currentAction="view";var s=this.$refs.formModal;s.setReadonly(!0),s.setTitle(i.view.modalTitle?i.view.modalTitle:r.name),s.setItems(o(this.currentAction)),s.show(a),i&&i.view&&i.view.query?i.view.query(e).then(function(e){var t=e,o=null!=i.view.queryDataField?i.view.queryDataField:_conf.default.proxyConfig.view.queryDataField;o&&(t=_utils.default.getObjData(o,e)),s.setFormData(t)}):s.setFormData(e)},filterFormItems:function(t){return this.form.props.items.filter(function(e){return!(e.filter&&!e.filter.includes(t))})}},render:function(e){var t=this.tableProps,o=this.modal,i=this.form,r=this.table,a=r.height?r.height:"auto";return e("div",{class:"crud-table"},[renderFormModal(o,i,e,this),e("div",{style:{height:a}},[e("data-table",t,"")])])}};exports.default=_default2;