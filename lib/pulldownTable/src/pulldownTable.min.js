"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.join"),require("core-js/modules/es.array.map"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.object.keys"),require("core-js/modules/web.dom-collections.for-each"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_dataTable=require("../../dataTable"),_vxeTable=require("vxe-table"),_init=require("../../init");function renderInput(e,t){var r=t.onInputFocus,o=t.onInputKeyUp,a=t.text,n=t.onCancelChange,l=t.disabled,s=t.inputProps;return e("a-input",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({placeholder:"",disabled:l,allowClear:!0},s),{},{value:a}),on:{focus:r,keyup:o,change:n}})}var pulldownPropKeys=Object.keys(_vxeTable.Pulldown.props),_default={name:"PulldownTable",components:{DataTable:_dataTable.DataTable},props:{table:Object,valueField:{type:String,default:"id"},textField:{type:String,default:"name"},searchBefore:Function,searchField:{type:String,default:"keyword"},value:{type:[Object,Array,String,Number]},disabled:Boolean,inputProps:{type:[Object]}},data:function(){return{tableData:[],selectValue:"",inputChangeValue:""}},computed:{text:function(){var t=this,e=this.selectValue,r="";return e&&_init.utils.isArray(e)?r=e.map(function(e){return e[t.textField]}).join(","):e&&_init.utils.isObject(e)?r=e[this.textField]:e&&(r=e),r},pulldownExtendProps:function(){var t=this,r={};return pulldownPropKeys.forEach(function(e){r[e]=t[e]}),r},pulldownProps:function(){var e=this.pulldownExtendProps,t=this.$scopedSlots,r=this.$options.propsData,o=Object.assign({},e);return Object.assign(o,{props:(0,_objectSpread2.default)({transfer:!0,"destroy-on-close":!0},r)}),o.ref="pulldownTable",o.scopedSlots=t,o.class="pulldown",o.on={"hide-panel":this.onPulldownHide},o},tableProps:function(){var e=this.table,t=this.tableData,r=this.$scopedSlots,o=this.onTableRowSelect,a=this.onTableCheckboxChange,n={props:(0,_objectSpread2.default)((0,_objectSpread2.default)({"show-overflow":!0},e.props),{},{data:t,columns:e.props.columns}),on:{"current-change":o,"checkbox-change":a,"checkbox-all":a},style:(0,_objectSpread2.default)({background:"#fff"},e.style),class:"pulldown-table",slot:"dropdown"};return e.props.proxyConfig&&e.props.proxyConfig.ajax&&(n.props.proxyConfig={ajax:(0,_objectSpread2.default)({},e.props.proxyConfig.ajax)}),n.scopedSlots=r,n.ref="table",n}},watch:{value:function(e){this.selectValue=e}},created:function(){this.onChange=_init.utils.debounce(this.onInputChange,400),this.selectValue=this.value},methods:{onTableRowSelect:function(e){var t=e.row;this.selectValue=t[this.valueField],this.$emit("change",this.selectValue,t),this.$refs.pulldownTable.hidePanel()},onTableCheckboxChange:function(e){var t=e.records;this.selectValue=t,this.$emit("change",this.selectValue)},onInputFocus:function(){this.$refs.pulldownTable.showPanel(),this.$emit("showPanel"),this.selectValue="";var e=this.table,t=this.searchBefore,r=this.searchField;if(e.props.proxyConfig&&e.props.proxyConfig.ajax&&e.props.proxyConfig.ajax.query){var o={};if(o[r]="",t){var a=t&&t(o);if(!1===a)return!1;a&&(o=a)}this.$refs.table.onSearchSubmit(o)}},onInputChange:function(e){var t=e.target.value;"click"===e.type&&(t="");var r=this.$refs.pulldownTable,o=this.table,a=this.searchBefore,n=this.searchField;if(o.props.proxyConfig&&o.props.proxyConfig.ajax&&o.props.proxyConfig.ajax.query&&r&&r.isPanelVisible()){var l={};if(l[n]=t,a){var s=a&&a(l);if(!1===s)return!1;s&&(l=s)}this.$refs.table.onSearchSubmit(l)}this.inputChangeValue=t,this.$emit("inputChange",e)},onCancelChange:function(e){"click"===e.type&&this.$emit("change","",{})},onInputEnter:function(){var e=this.$refs.table,t=this.$refs.pulldownTable,r=e.getCurrentRecord();r&&t.isPanelVisible()?this.onTableRowSelect({row:r}):this.onInputFocus()},onInputKeyUp:function(e){var t=e.key,r=this.$refs,o=this.onInputEnter,a=this.valueField;if("Enter"==t)return o(),!1;if("ArrowDown"!=t&&"ArrowUp"!=t)return this.onChange(e),!1;var n=r.table,l=n.getData(),s=n.getCurrentRecord();if(!s&&l&&l.length)n.setCurrentRow(l[0]);else if(l&&l.length){var i=l.findIndex(function(e){return e[a]===s[a]}),u=0;"ArrowUp"===t?(u=i-1)<0&&(u=0):u=i+1,l[u]&&n.setCurrentRow(l[u])}},onPulldownHide:function(){var e=this;this.selectValue=this.inputChangeValue,this.$nextTick(function(){e.selectValue=e.value})}},render:function(e){var t=this.tableProps,r=this.pulldownProps;return e("vxe-pulldown",(0,_objectSpread2.default)((0,_objectSpread2.default)({},r),{on:(0,_objectSpread2.default)({},r.on)}),[renderInput(e,this),e("data-table",(0,_objectSpread2.default)((0,_objectSpread2.default)({},t),{on:(0,_objectSpread2.default)({},t.on)}))])}};exports.default=_default;