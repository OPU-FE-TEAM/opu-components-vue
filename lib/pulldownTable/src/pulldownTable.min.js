"use strict";var _interopRequireDefault=require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.join"),require("core-js/modules/es.array.map"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.object.keys"),require("core-js/modules/web.dom-collections.for-each"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("D:/OpenSource/OPU/opu-components-vue/node_modules/@babel/runtime/helpers/esm/objectSpread2")),_dataTable=require("../../dataTable"),_vxeTable=require("vxe-table"),_init=require("../../init");function renderInput(e,t){var o=t.onInputFocus,r=t.onChange,a=t.text,n=t.disabled,l=t.inputProps,s=t.onInputKeyUp;return e("a-input",{props:(0,_objectSpread2.default)((0,_objectSpread2.default)({placeholder:"",disabled:n,allowClear:!0},l),{},{value:a}),on:{focus:o,keyup:s,input:r}})}var pulldownPropKeys=Object.keys(_vxeTable.Pulldown.props),_default={name:"PulldownTable",components:{DataTable:_dataTable.DataTable},props:{table:Object,valueField:{type:String,default:"id"},textField:{type:String,default:"name"},searchBefore:Function,searchField:{type:String,default:"keyword"},value:{type:[Object,Array,String,Number]},disabled:Boolean,inputProps:{type:[Object]},allowInputValue:Boolean},data:function(){return{tableData:[],selectValue:"",inputChangeValue:""}},computed:{text:function(){var t=this,e=this.selectValue,o="";return e&&_init.utils.isArray(e)?o=e.map(function(e){return e[t.textField]}).join(","):e&&_init.utils.isObject(e)?o=e[this.textField]:e&&(o=e),o},pulldownExtendProps:function(){var t=this,o={};return pulldownPropKeys.forEach(function(e){o[e]=t[e]}),o},pulldownProps:function(){var e=this.pulldownExtendProps,t=this.$scopedSlots,o=this.$options.propsData,r=Object.assign({},e);return Object.assign(r,{props:(0,_objectSpread2.default)({transfer:!0,"destroy-on-close":!0},o)}),r.ref="pulldownTable",r.scopedSlots=t,r.class="pulldown",r.on={"hide-panel":this.onPulldownHide},r},tableProps:function(){var e=this.table,t=this.tableData,o=this.$scopedSlots,r=this.onTableRowSelect,a=this.onTableCheckboxChange,n={props:(0,_objectSpread2.default)((0,_objectSpread2.default)({"show-overflow":!0},e.props),{},{data:t,columns:e.props.columns}),on:{"current-change":r,"checkbox-change":a,"checkbox-all":a},style:(0,_objectSpread2.default)({background:"#fff"},e.style),class:"pulldown-table",slot:"dropdown"};return e.props.proxyConfig&&e.props.proxyConfig.ajax&&(n.props.proxyConfig={ajax:(0,_objectSpread2.default)({},e.props.proxyConfig.ajax)}),n.scopedSlots=o,n.ref="table",n}},watch:{value:function(e){this.selectValue=e}},created:function(){this.onChange=_init.utils.debounce(this.onInputChange,400),this.selectValue=this.value},methods:{onTableRowSelect:function(e){var t=e.row;this.selectValue=t[this.valueField],this.$emit("change",this.selectValue,t),this.$refs.pulldownTable.hidePanel()},onTableCheckboxChange:function(e){var t=e.records;this.selectValue=t,this.$emit("change",this.selectValue)},onInputFocus:function(e){this.$refs.pulldownTable.showPanel(),this.$emit("showPanel",e),this.allowInputValue?this.inputChangeValue=this.selectValue:this.selectValue="";var t=this.table,o=this.searchBefore,r=this.searchField;if(t.props.proxyConfig&&t.props.proxyConfig.ajax&&t.props.proxyConfig.ajax.query){var a={};if(a[r]="",o){var n=o&&o(a);if(!1===n)return!1;n&&(a=n)}this.$refs.table.onSearchSubmit(a)}},onInputChange:function(e){var t=e.target.value;if(console.log(t),"click"===e.type)return t="",this.$emit("change","",{}),!1;var o=this.$refs.pulldownTable,r=this.table,a=this.searchBefore,n=this.searchField;if(r.props.proxyConfig&&r.props.proxyConfig.ajax&&r.props.proxyConfig.ajax.query&&o&&o.isPanelVisible()){var l={};if(l[n]=t,a){var s=a&&a(l);if(!1===s)return!1;s&&(l=s)}this.$refs.table.onSearchSubmit(l)}this.inputChangeValue=t,this.$emit("inputChange",e)},onCancelChange:function(e){"click"===e.type&&this.$emit("change","",{})},onInputEnter:function(){var e=this.$refs.table,t=this.$refs.pulldownTable,o=e.getCurrentRecord();o&&t.isPanelVisible()?this.onTableRowSelect({row:o}):this.onInputFocus()},onInputKeyUp:function(e){var t=e.key,o=this.$refs,r=this.onInputEnter,a=this.valueField;if("Enter"==t)return r(),!1;if("ArrowDown"!=t&&"ArrowUp"!=t)return!1;var n=o.table,l=n.getData(),s=n.getCurrentRecord();if(!s&&l&&l.length)n.setCurrentRow(l[0]);else if(l&&l.length){var i=l.findIndex(function(e){return e[a]===s[a]}),u=0;"ArrowUp"===t?(u=i-1)<0&&(u=0):u=i+1,l[u]&&n.setCurrentRow(l[u])}},onPulldownHide:function(){var e=this;this.allowInputValue?(this.selectValue=this.inputChangeValue,this.$emit("change",this.selectValue,{})):this.$nextTick(function(){e.selectValue=e.value})}},render:function(e){var t=this.tableProps,o=this.pulldownProps;return e("vxe-pulldown",(0,_objectSpread2.default)((0,_objectSpread2.default)({},o),{on:(0,_objectSpread2.default)({},o.on)}),[renderInput(e,this),e("data-table",(0,_objectSpread2.default)((0,_objectSpread2.default)({},t),{on:(0,_objectSpread2.default)({},t.on)}))])}};exports.default=_default;